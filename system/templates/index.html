<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能车载控制面板</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #0099ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-size: 16px;
            font-weight: bold;
            color: #00ffff;
        }

        .user-role {
            font-size: 12px;
            color: #cccccc;
        }

        .time {
            font-size: 20px;
            font-weight: bold;
            color: #00ffff;
        }

        .status-icons {
            display: flex;
            gap: 15px;
        }

        .status-icons i {
            font-size: 18px;
            color: #00ff88;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-link {
            padding: 8px 16px;
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(0, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        .main {
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: calc(100vh - 160px);
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .warning-lights {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .warning-light {
            font-size: 20px;
            color: #ffaa00;
        }

        .flashing {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        #gauge {
            height: 400px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
        }

        .panel p {
            color: #00ffff;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        #live-output h2 {
            color: #00ffff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        #output-box {
            background: #001f33;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            color: #ffffff;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        #output-box p {
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
            border-radius: 3px;
        }

        .right-panel {
            flex: 2;
        }

        .card-container {
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-slider {
            display: flex;
            gap: 20px;
            transition: transform 0.3s ease;
        }

        .card {
            min-width: calc(50% - 10px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }

        .card.active {
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            transform: translateY(-5px) scale(1.02);
            background: rgba(0, 255, 255, 0.15);
        }

        .card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00ffff, #0099ff);
        }

        .card i {
            font-size: 40px;
            color: #00ffff;
            margin-bottom: 15px;
        }

        .card h2 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .card p {
            color: #cccccc;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.4;
        }

        /* 增强状态指示器样式 */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            margin-left: 8px;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
        }

        .status-indicator.status-off {
            background: #ff6b6b;
            animation: none;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
        }

        /* 状态变化动画 */
        @keyframes statusChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); box-shadow: 0 0 20px currentColor; }
            100% { transform: scale(1); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .btn {
            background: linear-gradient(45deg, #0099ff, #00ffff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 153, 255, 0.4);
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }

        .arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 255, 255, 0.8);
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .prev-arrow {
            left: 10px;
        }

        .next-arrow {
            right: 10px;
        }

        .arrow:hover {
            background: rgba(0, 255, 255, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: #cccccc;
        }

        .menu-item:hover {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            transform: translateY(-2px);
        }

        .menu-item i {
            font-size: 20px;
        }

        .menu-item span {
            font-size: 12px;
        }

        /* 增强通知样式 */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.9), rgba(106, 183, 255, 0.9));
            color: #000;
            padding: 20px 40px;
            border-radius: 15px;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .notification.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1.05);
        }

        .voice-indicator {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #ff6b6b, #ff4757);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 75, 87, 0.4);
            z-index: 1000;
        }

        .voice-indicator:hover {
            transform: scale(1.1);
        }

        .voice-indicator.listening {
            animation: voicePulse 1.5s infinite;
            background: radial-gradient(circle, #00ff88, #00d47a);
        }

        .voice-indicator.recording {
            animation: recordingPulse 0.8s infinite;
            background: radial-gradient(circle, #ff4757, #ff3742);
        }

        @keyframes voicePulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes recordingPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .voice-panel {
            position: fixed;
            bottom: 170px;
            right: 30px;
            width: 320px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 20px;
            display: none;
            z-index: 999;
            backdrop-filter: blur(10px);
        }

        .voice-panel.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .voice-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00ffff;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .voice-input::placeholder {
            color: #aaa;
        }

        .voice-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .voice-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px 15px;
            background: linear-gradient(45deg, #0099ff, #00ffff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        .voice-btn.recording {
            background: linear-gradient(45deg, #ff4757, #ff6b6b);
        }

        .voice-btn.disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .voice-btn i {
            font-size: 16px;
        }

        .temp-display {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            margin: 10px 0;
        }

        .volume-display {
            font-size: 18px;
            color: #00ff88;
            margin: 10px 0;
        }

        /* 语音识别状态指示 */
        .voice-status {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 12px;
            color: #00ffff;
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .voice-status.processing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-color: rgba(255, 193, 7, 0.3);
        }

        .voice-status.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <div class="user-avatar">{{ username[0].upper() if username else 'U' }}</div>
            <div class="user-details">
                <div class="username">{{ username or '未知用户' }}</div>
                <div class="user-role">
                    {% if role == 'admin' %}🔧 管理员
                    {% elif role == 'driver' %}🚗 驾驶员
                    {% elif role == 'passenger' %}👤 乘客
                    {% else %}👤 用户
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="time" id="time-display">--:--:--</div>
        <div class="nav-links">
            <a href="/logout" class="nav-link">🚪 退出</a>
        </div>
        <div class="status-icons">
            <i class="fas fa-wifi"></i>
            <i class="fas fa-bluetooth"></i>
            <i class="fas fa-signal"></i>
            <i class="fas fa-car"></i>
        </div>
    </div>

    <div class="main">
        <div class="left-panel">
            <div class="warning-lights">
                <i class="fas fa-triangle-exclamation warning-light flashing"></i>
                <i class="fas fa-car-battery warning-light"></i>
                <i class="fas fa-thermometer-half warning-light"></i>
                <i class="fa fa-bell"></i>
            </div>
            <div id="gauge"></div>
            <div class="panel">
                <p>> 系统启动 . . .</p>
                <p>> 欢迎回来，{{ username or '用户' }}</p>
                <p>> 当前身份：
                {% if role == 'admin' %}系统管理员
                {% elif role == 'driver' %}主驾驶员
                {% elif role == 'passenger' %}车内乘客
                {% else %}访客用户
                {% endif %}
                </p>
                <p>> 语音识别模式：按需启动 ✅</p>
                <div id="live-output" style="margin-top: 20px;">
                    <h2>实时系统输出</h2>
                    <div id="output-box"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card-container">
                <button class="arrow prev-arrow" onclick="prevSlide()">&#10094;</button>
                <div class="card-slider" id="card-slider">
                    <div class="card">
                        <i class="fas fa-home"></i>
                        <h2>首页 <span class="status-indicator"></span></h2>
                        <p>显示设备概览和常用快捷操作，返回主控制界面</p>
                        <button class="btn" onclick="showNotification('已返回主界面')">返回首页</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-location-arrow"></i>
                        <h2>导航 <span class="status-indicator status-off" id="nav-indicator"></span></h2>
                        <p>提供位置服务和路线规划，支持室内外导航</p>
                        <div id="nav-destination" style="margin: 10px 0; font-style: italic; color: #00ffff;">暂无目的地</div>
                        <button class="btn" onclick="toggleNavigation()">开始导航</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-music"></i>
                        <h2>媒体 <span class="status-indicator status-off" id="media-indicator"></span></h2>
                        <p>多媒体播放控制，支持音乐、视频和图片浏览</p>
                        <div class="volume-display" id="media-volume">音量: 70%</div>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="70" class="slider" id="volume-slider">
                        </div>
                        <button class="btn" onclick="toggleMedia()">播放/暂停</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-satellite-dish"></i>
                        <h2>通信</h2>
                        <p>管理电话、消息和视频通话等通信功能</p>
                        <button class="btn" onclick="showNotification('正在连接通信服务...')">连接设备</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-cogs"></i>
                        <h2>系统设置</h2>
                        <p>调整设备参数、网络设置和个性化选项</p>
                        <button class="btn" onclick="showNotification('打开系统设置面板')">打开设置</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-camera"></i>
                        <h2>摄像头 <span class="status-indicator status-off" id="camera-indicator"></span></h2>
                        <p>控制摄像头设备，拍照、录像和监控</p>
                        <button class="btn" onclick="toggleCamera()">开启/关闭</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-robot"></i>
                        <h2>AI助手</h2>
                        <p>智能语音助手，提供帮助和智能服务</p>
                        <button class="btn" onclick="showNotification('你好！我是AI助手，很高兴为您服务')">对话</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-music"></i>
                        <h2>音乐 <span class="status-indicator status-off" id="music-indicator"></span></h2>
                        <p>音乐播放器，支持在线流媒体和本地播放</p>
                        <div class="volume-display" id="music-volume">音量: 40%</div>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="40" class="slider" id="music-slider">
                        </div>
                        <button class="btn" onclick="toggleMusic()">播放音乐</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-snowflake"></i>
                        <h2>空调控制 <span class="status-indicator status-off" id="ac-indicator"></span></h2>
                        <p>调节温度、风速和运行模式</p>
                        <div class="temp-display" id="ac-temp">温度: 24°C</div>
                        <div style="margin: 10px 0; color: #00ff88;" id="ac-mode">模式: 制冷</div>
                        <div class="slider-container">
                            <input type="range" min="16" max="30" value="24" class="slider" id="temp-slider">
                        </div>
                        <button class="btn" onclick="toggleAC()">开关空调</button>
                    </div>
                </div>
                <button class="arrow next-arrow" onclick="nextSlide()">&#10095;</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="menu-item" onclick="showNotification('返回主界面')">
            <i class="fas fa-home"></i>
            <span>首页</span>
        </div>
        <div class="menu-item" onclick="toggleNavigation()">
            <i class="fas fa-location-arrow"></i>
            <span>导航</span>
        </div>
        <div class="menu-item" onclick="toggleMedia()">
            <i class="fas fa-music"></i>
            <span>媒体</span>
        </div>
        <div class="menu-item" onclick="showNotification('打开通信面板')">
            <i class="fas fa-satellite-dish"></i>
            <span>通信</span>
        </div>
        <div class="menu-item" onclick="showNotification('打开系统设置')">
            <i class="fas fa-cogs"></i>
            <span>设置</span>
        </div>
        <div class="menu-item" onclick="toggleCamera()">
            <i class="fas fa-camera"></i>
            <span>摄像头</span>
        </div>
        <div class="menu-item" onclick="showNotification('启动AI助手')">
            <i class="fas fa-robot"></i>
            <span>AI助手</span>
        </div>
        <div class="menu-item" onclick="toggleMusic()">
            <i class="fas fa-music"></i>
            <span>音乐</span>
        </div>
        <div class="menu-item" onclick="toggleAC()">
            <i class="fas fa-snowflake"></i>
            <span>空调</span>
        </div>
    </div>

    <div class="voice-indicator" id="voice-indicator">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
        </svg>
    </div>

    <div class="voice-panel" id="voice-panel">
        <h3 style="color: #00ffff; margin-bottom: 15px;">🎤 语音控制面板</h3>
        <div class="voice-status" id="voice-status">准备就绪 - 点击录音按钮开始</div>
        <input type="text" class="voice-input" id="voice-input" placeholder="或直接输入指令，如：打开空调、播放音乐等">
        <div class="voice-buttons" id="voice-buttons">
            <button class="voice-btn" onclick="startRecording()" id="record-btn">
                <i class="fas fa-microphone"></i> 开始录音
            </button>
            <button class="voice-btn" onclick="sendVoiceCommand()" id="send-btn">
                <i class="fas fa-paper-plane"></i> 发送指令
            </button>
            <button class="voice-btn" onclick="closeVoicePanel()" id="close-btn">
                <i class="fas fa-times"></i> 关闭
            </button>
        </div>
    </div>

    <div class="notification" id="notification">
        操作成功！
    </div>

   <script>
    let currentIndex = 0;
    const slides = document.querySelectorAll('.card');
    const totalSlides = slides.length;
    let isListening = false;
    let isRecording = false;
    let isProcessing = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimeout = null;
    
    let vehicleState = {
        ac: { status: "关闭", temperature: 24, mode: "制冷" },
        music: { status: "暂停", volume: 40 },
        navigation: { status: "关闭", destination: "" },
        camera: { status: "关闭" },
        media: { status: "暂停", volume: 70 }
    };

    // 更新语音状态显示
    function updateVoiceStatus(message, type = 'normal') {
        const statusElement = document.getElementById('voice-status');
        statusElement.textContent = message;
        
        statusElement.className = 'voice-status';
        if (type === 'processing') {
            statusElement.classList.add('processing');
        } else if (type === 'error') {
            statusElement.classList.add('error');
        }
    }

    // 处理语音指令结果 - 关键函数
    function handleCommandResult(result) {
        console.log('处理指令结果:', result);
        
        if (result.success) {
            // 显示成功消息
            showNotification(result.message, 'success');
            addLogEntry(`✅ ${result.message}`);
            updateVoiceStatus(`✅ ${result.message}`, 'normal');
            
            // 更新车辆状态
            if (result.status_changes) {
                Object.assign(vehicleState, result.status_changes);
            }
            
            // 执行UI更新
            if (result.ui_updates) {
                executeUIUpdates(result.ui_updates);
            }
            
            // 根据动作类型执行特定更新
            switch(result.action) {
                case 'ac_on':
                case 'ac_off':
                case 'ac_temp':
                    updateACUI();
                    break;
                case 'music_play':
                case 'music_pause':
                case 'music_volume':
                    updateMusicUI();
                    break;
                case 'nav_on':
                case 'nav_off':
                case 'nav_destination':
                    updateNavigationUI();
                    break;
                case 'camera_on':
                case 'camera_off':
                    updateCameraUI();
                    break;
            }
        } else {
            // 显示错误消息
            showNotification(result.message, 'error');
            addLogEntry(`❌ ${result.message}`);
            updateVoiceStatus(`❌ ${result.message}`, 'error');
        }
    }

    // 执行UI更新 - 关键函数
    function executeUIUpdates(updates) {
        // 更新状态指示灯
        if (updates.ac_indicator) {
            updateStatusIndicator('ac-indicator', updates.ac_indicator === 'on');
        }
        if (updates.music_indicator) {
            updateStatusIndicator('music-indicator', updates.music_indicator === 'on');
        }
        if (updates.nav_indicator) {
            updateStatusIndicator('nav-indicator', updates.nav_indicator === 'on');
        }
        if (updates.camera_indicator) {
            updateStatusIndicator('camera-indicator', updates.camera_indicator === 'on');
        }
        
        // 更新温度显示
        if (updates.ac_temp) {
            const tempDisplay = document.getElementById('ac-temp');
            const tempSlider = document.getElementById('temp-slider');
            if (tempDisplay) tempDisplay.textContent = `温度: ${updates.ac_temp}°C`;
            if (tempSlider) tempSlider.value = updates.ac_temp;
        }
        
        // 更新音量显示
        if (updates.music_volume) {
            const volumeDisplay = document.getElementById('music-volume');
            const volumeSlider = document.getElementById('music-slider');
            if (volumeDisplay) volumeDisplay.textContent = `音量: ${updates.music_volume}%`;
            if (volumeSlider) volumeSlider.value = updates.music_volume;
        }
        
        // 更新导航目的地
        if (updates.nav_destination) {
            const destDisplay = document.getElementById('nav-destination');
            if (destDisplay) destDisplay.textContent = updates.nav_destination;
        }
        
        // 高亮相关卡片
        if (updates.highlight_card) {
            highlightCardByType(updates.highlight_card);
        }
    }

    // 根据类型高亮卡片
    function highlightCardByType(type) {
        const cardMap = {
            'ac': '.card:nth-child(9)',
            'music': '.card:nth-child(8)',
            'navigation': '.card:nth-child(2)',
            'camera': '.card:nth-child(6)',
            'media': '.card:nth-child(3)'
        };
        
        if (cardMap[type]) {
            highlightCard(cardMap[type]);
        }
    }

    // 初始化录音功能
    async function initAudioRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 16000
                } 
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                audioChunks = [];
                await sendAudioToBackend(audioBlob);
            };
            
            console.log('✅ 录音功能初始化成功');
            updateVoiceStatus('录音功能就绪 - 可以开始语音交互', 'normal');
            return true;
        } catch (error) {
            console.error('❌ 录音功能初始化失败:', error);
            updateVoiceStatus('录音功能不可用 - 请检查麦克风权限', 'error');
            showNotification('无法访问麦克风，请检查权限设置', 'error');
            return false;
        }
    }

    // 开始录音
    async function startRecording() {
        if (isProcessing) {
            showNotification('正在处理中，请稍候...', 'info');
            return;
        }

        if (isRecording) {
            stopRecording();
            return;
        }

        if (!mediaRecorder) {
            const success = await initAudioRecording();
            if (!success) return;
        }
        
        try {
            audioChunks = [];
            mediaRecorder.start();
            isRecording = true;
            
            // 更新UI
            const voiceIndicator = document.getElementById('voice-indicator');
            const recordBtn = document.getElementById('record-btn');
            
            voiceIndicator.classList.add('recording');
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = '<i class="fas fa-stop"></i> 停止录音';
            
            updateVoiceStatus('🎤 正在录音... 请清晰说话（最长10秒）', 'processing');
            addLogEntry('🎤 开始录音，请说话...');
            
            // 10秒后自动停止录音
            recordingTimeout = setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                    addLogEntry('⏰ 录音时间达到上限，自动停止');
                }
            }, 10000);
            
        } catch (error) {
            console.error('录音启动失败:', error);
            updateVoiceStatus('录音启动失败', 'error');
            showNotification('录音启动失败，请检查麦克风权限', 'error');
            resetRecordingUI();
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            resetRecordingUI();
            updateVoiceStatus('🔄 录音完成，正在识别...', 'processing');
            addLogEntry('📝 录音结束，开始Whisper识别...');
        }
    }

    function resetRecordingUI() {
        const voiceIndicator = document.getElementById('voice-indicator');
        const recordBtn = document.getElementById('record-btn');
        
        voiceIndicator.classList.remove('recording');
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<i class="fas fa-microphone"></i> 开始录音';
    }

    // 发送音频到后端（优化版）
    async function sendAudioToBackend(audioBlob) {
        if (isProcessing) return;
        isProcessing = true;
        
        try {
            console.log('🎤 发送音频到Whisper系统，大小:', audioBlob.size, 'bytes');
            
            const formData = new FormData();
            formData.append('audio', audioBlob, 'web_recording.webm');
            
            updateVoiceStatus('🔄 正在使用Whisper识别...', 'processing');
            
            const response = await fetch('/api/voice_recognition', {
                method: 'POST',
                body: formData,
                signal: AbortSignal.timeout(20000) // 20秒超时
            });
            
            if (!response.ok) {
                throw new Error(`网络错误: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('🎯 Whisper识别响应:', result);
            
            if (result.status === 'success') {
                const recognizedText = result.text;
                
                // 在输入框中显示识别结果
                const voiceInput = document.getElementById('voice-input');
                voiceInput.value = recognizedText;
                
                // 显示成功消息
                showNotification(`✅ 识别成功: ${recognizedText}`, 'success');
                addLogEntry(`✅ Whisper识别结果: ${recognizedText}`);
                updateVoiceStatus(`✅ 识别成功: ${recognizedText}`, 'normal');
                
                // 处理指令结果
                if (result.command_result) {
                    setTimeout(() => {
                        handleCommandResult(result.command_result);
                    }, 500);
                }
                
            } else {
                console.warn('Whisper识别失败:', result.message);
                showNotification(`识别失败: ${result.message}`, 'error');
                addLogEntry(`❌ Whisper识别失败: ${result.message}`);
                updateVoiceStatus(`❌ 识别失败: ${result.message}`, 'error');
            }
            
        } catch (error) {
            console.error('Whisper识别错误:', error);
            
            if (error.name === 'TimeoutError') {
                showNotification('Whisper识别超时，请重试', 'error');
                addLogEntry('⏰ Whisper识别超时');
                updateVoiceStatus('⏰ 识别超时，请重试', 'error');
            } else if (error.message.includes('网络')) {
                showNotification('网络连接异常', 'error');
                addLogEntry('📡 网络连接问题');
                updateVoiceStatus('📡 网络连接异常', 'error');
            } else {
                showNotification('Whisper识别服务异常，请重试', 'error');
                addLogEntry(`🔧 Whisper服务异常: ${error.message}`);
                updateVoiceStatus('🔧 服务异常，请重试', 'error');
            }
        } finally {
            isProcessing = false;
        }
    }

    function showSlide(index) {
        const slider = document.getElementById('card-slider');
        slider.style.transform = `translateX(${-index * 50}%)`;
    }

    function nextSlide() {
        if (currentIndex < totalSlides - 2) {
            currentIndex++;
            showSlide(currentIndex);
        }
    }

    function prevSlide() {
        if (currentIndex > 0) {
            currentIndex--;
            showSlide(currentIndex);
        }
    }

    // 修改showNotification函数，支持不同类型的消息
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        
        // 根据类型设置不同的样式
        if (type === 'error') {
            notification.style.background = 'linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 75, 87, 0.9))';
            notification.style.color = '#fff';
        } else if (type === 'info') {
            notification.style.background = 'linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 235, 59, 0.9))';
            notification.style.color = '#000';
        } else {
            notification.style.background = 'linear-gradient(135deg, rgba(0, 255, 255, 0.9), rgba(106, 183, 255, 0.9))';
            notification.style.color = '#000';
        }
        
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // 修改状态指示器更新函数，添加动画效果
    function updateStatusIndicator(elementId, isActive) {
        const indicator = document.getElementById(elementId);
        if (indicator) {
            if (isActive) {
                indicator.classList.remove('status-off');
                // 添加激活动画
                indicator.style.animation = 'statusChange 0.5s ease';
            } else {
                indicator.classList.add('status-off');
                indicator.style.animation = 'statusChange 0.5s ease';
            }
            
            // 清除动画
            setTimeout(() => {
                indicator.style.animation = '';
            }, 500);
        }
    }

    function highlightCard(cardSelector) {
        document.querySelectorAll('.card').forEach(card => {
            card.classList.remove('active');
        });
        
        const targetCard = document.querySelector(cardSelector);
        if (targetCard) {
            targetCard.classList.add('active');
            setTimeout(() => {
                targetCard.classList.remove('active');
            }, 3000);
        }
    }

    function toggleAC() {
        vehicleState.ac.status = vehicleState.ac.status === "开启" ? "关闭" : "开启";
        updateACUI();
        sendCommandToBackend(vehicleState.ac.status === "开启" ? "打开空调" : "关闭空调");
    }

    function updateACUI() {
        const indicator = document.getElementById('ac-indicator');
        const tempDisplay = document.getElementById('ac-temp');
        const modeDisplay = document.getElementById('ac-mode');
        const tempSlider = document.getElementById('temp-slider');
        
        updateStatusIndicator('ac-indicator', vehicleState.ac.status === "开启");
        tempDisplay.textContent = `温度: ${vehicleState.ac.temperature}°C`;
        modeDisplay.textContent = `模式: ${vehicleState.ac.mode}`;
        tempSlider.value = vehicleState.ac.temperature;
        
        highlightCard('.card:nth-child(9)');
    }

    function toggleMusic() {
        vehicleState.music.status = vehicleState.music.status === "播放" ? "暂停" : "播放";
        updateMusicUI();
        sendCommandToBackend(vehicleState.music.status === "播放" ? "播放音乐" : "暂停音乐");
    }

    function updateMusicUI() {
        const indicator = document.getElementById('music-indicator');
        const volumeDisplay = document.getElementById('music-volume');
        const volumeSlider = document.getElementById('music-slider');
        
        updateStatusIndicator('music-indicator', vehicleState.music.status === "播放");
        volumeDisplay.textContent = `音量: ${vehicleState.music.volume}%`;
        volumeSlider.value = vehicleState.music.volume;
        
        highlightCard('.card:nth-child(8)');
    }

    function toggleMedia() {
        vehicleState.media.status = vehicleState.media.status === "播放" ? "暂停" : "播放";
        updateMediaUI();
    }

    function updateMediaUI() {
        const indicator = document.getElementById('media-indicator');
        const volumeDisplay = document.getElementById('media-volume');
        const volumeSlider = document.getElementById('volume-slider');
        
        updateStatusIndicator('media-indicator', vehicleState.media.status === "播放");
        volumeDisplay.textContent = `音量: ${vehicleState.media.volume}%`;
        volumeSlider.value = vehicleState.media.volume;
        
        highlightCard('.card:nth-child(3)');
    }

    function toggleNavigation() {
        vehicleState.navigation.status = vehicleState.navigation.status === "开启" ? "关闭" : "开启";
        updateNavigationUI();
        sendCommandToBackend(vehicleState.navigation.status === "开启" ? "开启导航" : "关闭导航");
    }

    function updateNavigationUI() {
        const indicator = document.getElementById('nav-indicator');
        const destDisplay = document.getElementById('nav-destination');
        
        updateStatusIndicator('nav-indicator', vehicleState.navigation.status === "开启");
        destDisplay.textContent = vehicleState.navigation.destination || "暂无目的地";
        
        highlightCard('.card:nth-child(2)');
    }

    function toggleCamera() {
        vehicleState.camera.status = vehicleState.camera.status === "开启" ? "关闭" : "开启";
        updateCameraUI();
        showNotification(`摄像头已${vehicleState.camera.status}`);
    }

    function updateCameraUI() {
        updateStatusIndicator('camera-indicator', vehicleState.camera.status === "开启");
        highlightCard('.card:nth-child(6)');
    }

    function toggleVoiceListening() {
        const indicator = document.getElementById('voice-indicator');
        const panel = document.getElementById('voice-panel');
        
        if (!isListening) {
            panel.classList.add('show');
            updateVoiceStatus('语音面板已打开 - 点击录音按钮开始', 'normal');
            showNotification('🎤 语音控制面板已打开', 'info');
            isListening = true;
        } else {
            panel.classList.remove('show');
            if (isRecording) {
                stopRecording();
            }
            showNotification('语音控制已关闭', 'info');
            isListening = false;
        }
    }

    // 修改发送语音指令函数，添加指令结果处理
    async function sendVoiceCommand() {
        const input = document.getElementById('voice-input');
        const command = input.value.trim();
        
        if (command) {
            if (isProcessing) {
                showNotification('正在处理中，请稍候...', 'info');
                return;
            }

            isProcessing = true;
            updateVoiceStatus('🔄 正在处理文本指令...', 'processing');

            try {
                const response = await fetch('/api/test_voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: command })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // 处理指令结果
                    if (result.command_result) {
                        handleCommandResult(result.command_result);
                    }
                } else {
                    showNotification(result.message, 'error');
                    addLogEntry(`❌ ${result.message}`);
                    updateVoiceStatus(`❌ ${result.message}`, 'error');
                }
                
                input.value = '';
                
            } catch (error) {
                showNotification('发送失败', 'error');
                addLogEntry(`❌ 发送失败: ${error.message}`);
                updateVoiceStatus('❌ 发送失败', 'error');
            } finally {
                isProcessing = false;
            }
        } else {
            showNotification('请输入语音指令', 'info');
        }
    }

    function closeVoicePanel() {
        document.getElementById('voice-panel').classList.remove('show');
        if (isRecording) {
            stopRecording();
        }
        isListening = false;
        updateVoiceStatus('语音面板已关闭', 'normal');
    }

    async function sendCommandToBackend(command) {
        try {
            const response = await fetch('/api/test_voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: command })
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                if (result.command_result) {
                    handleCommandResult(result.command_result);
                }
                addLogEntry(`✅ ${result.message}`);
            } else {
                addLogEntry(`❌ ${result.message}`);
            }
        } catch (error) {
            addLogEntry(`❌ 发送失败: ${error.message}`);
        }
    }

    function initSliders() {
        const volumeSlider = document.getElementById('volume-slider');
        const musicSlider = document.getElementById('music-slider');
        const tempSlider = document.getElementById('temp-slider');
        
        volumeSlider.addEventListener('input', function() {
            vehicleState.media.volume = parseInt(this.value);
            document.getElementById('media-volume').textContent = `音量: ${this.value}%`;
            showNotification(`媒体音量调整至: ${this.value}%`, 'info');
        });
        
        musicSlider.addEventListener('input', function() {
            vehicleState.music.volume = parseInt(this.value);
            document.getElementById('music-volume').textContent = `音量: ${this.value}%`;
            sendCommandToBackend(`音量调到${this.value}`);
        });
        
        tempSlider.addEventListener('input', function() {
            vehicleState.ac.temperature = parseInt(this.value);
            document.getElementById('ac-temp').textContent = `温度: ${this.value}°C`;
            sendCommandToBackend(`调到${this.value}度`);
        });
    }

    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        document.getElementById('time-display').textContent = timeStr;
    }

    function updateUIFromBackend(data) {
        console.log('收到后端数据:', data);
        
        if (data.vehicle_state) {
            vehicleState = { ...vehicleState, ...data.vehicle_state };
            
            if (data.vehicle_state.ac) {
                updateACUI();
            }
            
            if (data.vehicle_state.music) {
                updateMusicUI();
            }
            
            if (data.vehicle_state.navigation) {
                updateNavigationUI();
            }
        }
    }

    function initGauge() {
        var myChart = echarts.init(document.getElementById('gauge'));
        var option = {
            backgroundColor: 'transparent',
            tooltip: {
                formatter: '{a} <br/>{c} {b}'
            },
            series: [
                {
                    name: '速度',
                    type: 'gauge',
                    min: 0,
                    max: 220,
                    splitNumber: 11,
                    radius: '85%',
                    axisLine: {
                        lineStyle: {
                            color: [[0.09, 'lime'], [0.82, '#1e90ff'], [1, '#ff4500']],
                            width: 3,
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    axisLabel: {
                        fontWeight: 'bolder',
                        color: '#fff',
                        shadowColor: '#fff',
                        shadowBlur: 10
                    },
                    axisTick: {
                        length: 15,
                        lineStyle: {
                            color: 'auto',
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    splitLine: {
                        length: 25,
                        lineStyle: {
                            width: 3,
                            color: '#fff',
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    pointer: {
                        shadowColor: '#fff',
                        shadowBlur: 5
                    },
                    title: {
                        textStyle: {
                            fontWeight: 'bolder',
                            fontSize: 14,
                            fontStyle: 'italic',
                            color: '#fff',
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    detail: {
                        backgroundColor: 'rgba(30,144,255,0.8)',
                        borderWidth: 1,
                        borderColor: '#fff',
                        shadowColor: '#fff',
                        shadowBlur: 5,
                        offsetCenter: [0, '50%'],
                        padding: [1, 1],
                        textStyle: {
                            fontWeight: 'bolder',
                            color: '#fff',
                            fontSize: 14
                        }
                    },
                    data: [{value: 40, name: 'km/h'}]
                }
            ]
        };
        
        setInterval(function() {
            option.series[0].data[0].value = (Math.random() * 100).toFixed(2) - 0;
            myChart.setOption(option);
        }, 2000);
        
        myChart.setOption(option);
    }

    // 修改EventSource处理函数，处理指令结果
    function initEventSource() {
        const outputContent = document.getElementById("output-box");
        const eventSource = new EventSource("/stream");
        
        eventSource.onmessage = function(event) {
            console.log("接收到数据：", event.data);
            try {
                const data = JSON.parse(event.data);
                
                // 处理不同类型的消息
                if (data.type === 'voice_command' || data.type === 'voice_recognition') {
                    addLogEntry(`🗣️ ${data.content}`);
                    
                    // 处理指令结果
                    if (data.command_result) {
                        setTimeout(() => {
                            handleCommandResult(data.command_result);
                        }, 100);
                    }
                } else if (data.content) {
                    addLogEntry(data.content);
                }
                
                // 更新UI状态
                updateUIFromBackend(data);
                
            } catch (e) {
                addLogEntry(event.data);
            }
        };
        
        eventSource.onerror = function(err) {
            console.error("SSE 错误：", err);
            addLogEntry("❌ 连接已断开，请检查后端状态或刷新页面。");
        };
    }

    function addLogEntry(message) {
        const outputContent = document.getElementById("output-box");
        const timestamp = new Date().toLocaleTimeString();
        const p = document.createElement('p');
        p.textContent = `[${timestamp}] ${message}`;
        outputContent.prepend(p);
        
        if (outputContent.children.length > 20) {
            outputContent.removeChild(outputContent.lastChild);
        }
    }

    // 键盘事件监听
    document.getElementById('voice-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendVoiceCommand();
        }
    });

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        showSlide(currentIndex);
        initSliders();
        initGauge();
        initEventSource();
        
        // 初始化录音功能（延迟初始化，避免阻塞页面加载）
        setTimeout(() => {
            initAudioRecording();
        }, 1000);
        
        document.getElementById('voice-indicator').addEventListener('click', toggleVoiceListening);
        
        setInterval(updateTime, 1000);
        updateTime();
        
        setTimeout(() => {
            addLogEntry('🚗 车载面板初始化完成，语音识别就绪');
            addLogEntry('💡 点击右下角麦克风图标开始语音交互');
            addLogEntry('🎤 支持的指令：打开/关闭空调、播放/暂停音乐、开启/关闭导航等');
            addLogEntry('✅ 语音识别模式：按需启动（只在点击录音按钮时进行识别）');
        }, 1000);
    });
</script>
</body>
</html>