<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½è½¦è½½æ§åˆ¶é¢æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.0/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ffff, #0099ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-size: 16px;
            font-weight: bold;
            color: #00ffff;
        }

        .user-role {
            font-size: 12px;
            color: #cccccc;
        }

        .time {
            font-size: 20px;
            font-weight: bold;
            color: #00ffff;
        }

        .status-icons {
            display: flex;
            gap: 15px;
        }

        .status-icons i {
            font-size: 18px;
            color: #00ff88;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-link {
            padding: 8px 16px;
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(0, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        .main {
            display: flex;
            gap: 20px;
            padding: 20px;
            min-height: calc(100vh - 160px);
        }

        .left-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .warning-lights {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .warning-light {
            font-size: 20px;
            color: #ffaa00;
        }

        .flashing {
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        #gauge {
            height: 400px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1;
        }

        .panel p {
            color: #00ffff;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        #live-output h2 {
            color: #00ffff;
            margin-bottom: 15px;
            font-size: 18px;
        }

        #output-box {
            background: #001f33;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            color: #ffffff;
            font-family: monospace;
            font-size: 14px;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        #output-box p {
            margin: 5px 0;
            padding: 5px;
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00ffff;
            border-radius: 3px;
        }

        .right-panel {
            flex: 2;
        }

        .card-container {
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-slider {
            display: flex;
            gap: 20px;
            transition: transform 0.3s ease;
        }

        .card {
            min-width: calc(50% - 10px);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
        }

        .card.active {
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
            transform: translateY(-5px) scale(1.02);
            background: rgba(0, 255, 255, 0.15);
        }

        .card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #00ffff, #0099ff);
        }

        .card i {
            font-size: 40px;
            color: #00ffff;
            margin-bottom: 15px;
        }

        .card h2 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 20px;
        }

        .card p {
            color: #cccccc;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.4;
        }

        /* å¢å¼ºçŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #00ff88;
            margin-left: 8px;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.6);
        }

        .status-indicator.status-off {
            background: #ff6b6b;
            animation: none;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
        }

        /* çŠ¶æ€å˜åŒ–åŠ¨ç”» */
        @keyframes statusChange {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); box-shadow: 0 0 20px currentColor; }
            100% { transform: scale(1); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .btn {
            background: linear-gradient(45deg, #0099ff, #00ffff);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 153, 255, 0.4);
        }

        .slider-container {
            margin: 15px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.6);
        }

        .arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 255, 255, 0.8);
            color: white;
            border: none;
            padding: 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 50%;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .prev-arrow {
            left: 10px;
        }

        .next-arrow {
            right: 10px;
        }

        .arrow:hover {
            background: rgba(0, 255, 255, 1);
            transform: translateY(-50%) scale(1.1);
        }

        .footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            color: #cccccc;
        }

        .menu-item:hover {
            background: rgba(0, 255, 255, 0.2);
            color: #00ffff;
            transform: translateY(-2px);
        }

        .menu-item i {
            font-size: 20px;
        }

        .menu-item span {
            font-size: 12px;
        }

        /* å¢å¼ºé€šçŸ¥æ ·å¼ */
        .notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.9), rgba(106, 183, 255, 0.9));
            color: #000;
            padding: 20px 40px;
            border-radius: 15px;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .notification.show {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1.05);
        }

        .voice-indicator {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #ff6b6b, #ff4757);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 75, 87, 0.4);
            z-index: 1000;
        }

        .voice-indicator:hover {
            transform: scale(1.1);
        }

        .voice-indicator.listening {
            animation: voicePulse 1.5s infinite;
            background: radial-gradient(circle, #00ff88, #00d47a);
        }

        .voice-indicator.recording {
            animation: recordingPulse 0.8s infinite;
            background: radial-gradient(circle, #ff4757, #ff3742);
        }

        @keyframes voicePulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes recordingPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .voice-panel {
            position: fixed;
            bottom: 170px;
            right: 30px;
            width: 320px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid #00ffff;
            border-radius: 15px;
            padding: 20px;
            display: none;
            z-index: 999;
            backdrop-filter: blur(10px);
        }

        .voice-panel.show {
            display: block;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .voice-input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #00ffff;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .voice-input::placeholder {
            color: #aaa;
        }

        .voice-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .voice-btn {
            flex: 1;
            min-width: 100px;
            padding: 10px 15px;
            background: linear-gradient(45deg, #0099ff, #00ffff);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .voice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }

        .voice-btn.recording {
            background: linear-gradient(45deg, #ff4757, #ff6b6b);
        }

        .voice-btn.disabled {
            background: #666;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .voice-btn i {
            font-size: 16px;
        }

        .temp-display {
            font-size: 24px;
            font-weight: bold;
            color: #00ffff;
            margin: 10px 0;
        }

        .volume-display {
            font-size: 18px;
            color: #00ff88;
            margin: 10px 0;
        }

        /* è¯­éŸ³è¯†åˆ«çŠ¶æ€æŒ‡ç¤º */
        .voice-status {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(0, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 12px;
            color: #00ffff;
            text-align: center;
            border: 1px solid rgba(0, 255, 255, 0.3);
        }

        .voice-status.processing {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-color: rgba(255, 193, 7, 0.3);
        }

        .voice-status.error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
        }
        .attention-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: urgentFlash 1s infinite;
        }

        .attention-warning-modal.show {
            display: flex;
        }

        .attention-warning-content {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 3px solid #ffff00;
            max-width: 500px;
            position: relative;
            animation: shake 0.5s infinite;
        }

        .warning-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: pulse 1s infinite;
        }

        .attention-warning-content h2 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #ffff00;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .attention-warning-content p {
            font-size: 20px;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .attention-response-btn {
            background: linear-gradient(45deg, #00ff00, #00cc00);
            color: #000;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 255, 0, 0.4);
        }

        .attention-response-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 255, 0, 0.6);
        }

        .attention-timer {
            margin-top: 20px;
            font-size: 16px;
            color: #ffff00;
            font-weight: bold;
        }

        #attention-countdown {
            font-size: 24px;
            color: #ffff00;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* ğŸ§ª æµ‹è¯•æŒ‰é’®æ ·å¼ */
        .test-warning-btn {
            position: fixed;
            bottom: 20px;
            left: 30px;
            background: linear-gradient(45deg, #ff6b6b, #ff4757);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            z-index: 1000;
        }

        .test-warning-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes urgentFlash {
            0%, 50% { background: rgba(255, 0, 0, 0.8); }
            51%, 100% { background: rgba(255, 100, 0, 0.8); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <div class="user-avatar">{{ username[0].upper() if username else 'U' }}</div>
            <div class="user-details">
                <div class="username">{{ username or 'æœªçŸ¥ç”¨æˆ·' }}</div>
                <div class="user-role">
                    {% if role == 'admin' %}ğŸ”§ ç®¡ç†å‘˜
                    {% elif role == 'driver' %}ğŸš— é©¾é©¶å‘˜
                    {% elif role == 'passenger' %}ğŸ‘¤ ä¹˜å®¢
                    {% else %}ğŸ‘¤ ç”¨æˆ·
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="time" id="time-display">--:--:--</div>
        <div class="nav-links">
            <a href="/logout" class="nav-link">ğŸšª é€€å‡º</a>
        </div>
        <div class="status-icons">
            <i class="fas fa-wifi"></i>
            <i class="fas fa-bluetooth"></i>
            <i class="fas fa-signal"></i>
            <i class="fas fa-car"></i>
        </div>
    </div>

    <div class="main">
        <div class="left-panel">
            <div class="warning-lights">
                <i class="fas fa-triangle-exclamation warning-light flashing"></i>
                <i class="fas fa-car-battery warning-light"></i>
                <i class="fas fa-thermometer-half warning-light"></i>
                <i class="fa fa-bell"></i>
            </div>
            <div id="gauge"></div>
            <div class="panel">
                <p>> ç³»ç»Ÿå¯åŠ¨ . . .</p>
                <p>> æ¬¢è¿å›æ¥ï¼Œ{{ username or 'ç”¨æˆ·' }}</p>
                <p>> å½“å‰èº«ä»½ï¼š
                {% if role == 'admin' %}ç³»ç»Ÿç®¡ç†å‘˜
                {% elif role == 'driver' %}ä¸»é©¾é©¶å‘˜
                {% elif role == 'passenger' %}è½¦å†…ä¹˜å®¢
                {% else %}è®¿å®¢ç”¨æˆ·
                {% endif %}
                </p>
                <p>> è¯­éŸ³è¯†åˆ«æ¨¡å¼ï¼šæŒ‰éœ€å¯åŠ¨ âœ…</p>
                <div id="live-output" style="margin-top: 20px;">
                    <h2>å®æ—¶ç³»ç»Ÿè¾“å‡º</h2>
                    <div id="output-box"></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="card-container">
                <button class="arrow prev-arrow" onclick="prevSlide()">&#10094;</button>
                <div class="card-slider" id="card-slider">
                    <div class="card">
                        <i class="fas fa-home"></i>
                        <h2>é¦–é¡µ <span class="status-indicator"></span></h2>
                        <p>æ˜¾ç¤ºè®¾å¤‡æ¦‚è§ˆå’Œå¸¸ç”¨å¿«æ·æ“ä½œï¼Œè¿”å›ä¸»æ§åˆ¶ç•Œé¢</p>
                        <button class="btn" onclick="showNotification('å·²è¿”å›ä¸»ç•Œé¢')">è¿”å›é¦–é¡µ</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-location-arrow"></i>
                        <h2>å¯¼èˆª <span class="status-indicator status-off" id="nav-indicator"></span></h2>
                        <p>æä¾›ä½ç½®æœåŠ¡å’Œè·¯çº¿è§„åˆ’ï¼Œæ”¯æŒå®¤å†…å¤–å¯¼èˆª</p>
                        <div id="nav-destination" style="margin: 10px 0; font-style: italic; color: #00ffff;">æš‚æ— ç›®çš„åœ°</div>
                        <button class="btn" onclick="toggleNavigation()">å¼€å§‹å¯¼èˆª</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-music"></i>
                        <h2>åª’ä½“ <span class="status-indicator status-off" id="media-indicator"></span></h2>
                        <p>å¤šåª’ä½“æ’­æ”¾æ§åˆ¶ï¼Œæ”¯æŒéŸ³ä¹ã€è§†é¢‘å’Œå›¾ç‰‡æµè§ˆ</p>
                        <div class="volume-display" id="media-volume">éŸ³é‡: 70%</div>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="70" class="slider" id="volume-slider">
                        </div>
                        <button class="btn" onclick="toggleMedia()">æ’­æ”¾/æš‚åœ</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-satellite-dish"></i>
                        <h2>é€šä¿¡</h2>
                        <p>ç®¡ç†ç”µè¯ã€æ¶ˆæ¯å’Œè§†é¢‘é€šè¯ç­‰é€šä¿¡åŠŸèƒ½</p>
                        <button class="btn" onclick="showNotification('æ­£åœ¨è¿æ¥é€šä¿¡æœåŠ¡...')">è¿æ¥è®¾å¤‡</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-cogs"></i>
                        <h2>ç³»ç»Ÿè®¾ç½®</h2>
                        <p>è°ƒæ•´è®¾å¤‡å‚æ•°ã€ç½‘ç»œè®¾ç½®å’Œä¸ªæ€§åŒ–é€‰é¡¹</p>
                        <button class="btn" onclick="showNotification('æ‰“å¼€ç³»ç»Ÿè®¾ç½®é¢æ¿')">æ‰“å¼€è®¾ç½®</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-camera"></i>
                        <h2>æ‘„åƒå¤´ <span class="status-indicator status-off" id="camera-indicator"></span></h2>
                        <p>æ§åˆ¶æ‘„åƒå¤´è®¾å¤‡ï¼Œæ‹ç…§ã€å½•åƒå’Œç›‘æ§</p>
                        <button class="btn" onclick="toggleCamera()">å¼€å¯/å…³é—­</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-robot"></i>
                        <h2>AIåŠ©æ‰‹</h2>
                        <p>æ™ºèƒ½è¯­éŸ³åŠ©æ‰‹ï¼Œæä¾›å¸®åŠ©å’Œæ™ºèƒ½æœåŠ¡</p>
                        <button class="btn" onclick="showNotification('ä½ å¥½ï¼æˆ‘æ˜¯AIåŠ©æ‰‹ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡')">å¯¹è¯</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-music"></i>
                        <h2>éŸ³ä¹ <span class="status-indicator status-off" id="music-indicator"></span></h2>
                        <p>éŸ³ä¹æ’­æ”¾å™¨ï¼Œæ”¯æŒåœ¨çº¿æµåª’ä½“å’Œæœ¬åœ°æ’­æ”¾</p>
                        <div class="volume-display" id="music-volume">éŸ³é‡: 40%</div>
                        <div class="slider-container">
                            <input type="range" min="0" max="100" value="40" class="slider" id="music-slider">
                        </div>
                        <button class="btn" onclick="toggleMusic()">æ’­æ”¾éŸ³ä¹</button>
                    </div>
                    <div class="card">
                        <i class="fas fa-snowflake"></i>
                        <h2>ç©ºè°ƒæ§åˆ¶ <span class="status-indicator status-off" id="ac-indicator"></span></h2>
                        <p>è°ƒèŠ‚æ¸©åº¦ã€é£é€Ÿå’Œè¿è¡Œæ¨¡å¼</p>
                        <div class="temp-display" id="ac-temp">æ¸©åº¦: 24Â°C</div>
                        <div style="margin: 10px 0; color: #00ff88;" id="ac-mode">æ¨¡å¼: åˆ¶å†·</div>
                        <div class="slider-container">
                            <input type="range" min="16" max="30" value="24" class="slider" id="temp-slider">
                        </div>
                        <button class="btn" onclick="toggleAC()">å¼€å…³ç©ºè°ƒ</button>
                    </div>
                </div>
                <button class="arrow next-arrow" onclick="nextSlide()">&#10095;</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="menu-item" onclick="showNotification('è¿”å›ä¸»ç•Œé¢')">
            <i class="fas fa-home"></i>
            <span>é¦–é¡µ</span>
        </div>
        <div class="menu-item" onclick="toggleNavigation()">
            <i class="fas fa-location-arrow"></i>
            <span>å¯¼èˆª</span>
        </div>
        <div class="menu-item" onclick="toggleMedia()">
            <i class="fas fa-music"></i>
            <span>åª’ä½“</span>
        </div>
        <div class="menu-item" onclick="showNotification('æ‰“å¼€é€šä¿¡é¢æ¿')">
            <i class="fas fa-satellite-dish"></i>
            <span>é€šä¿¡</span>
        </div>
        <div class="menu-item" onclick="showNotification('æ‰“å¼€ç³»ç»Ÿè®¾ç½®')">
            <i class="fas fa-cogs"></i>
            <span>è®¾ç½®</span>
        </div>
        <div class="menu-item" onclick="toggleCamera()">
            <i class="fas fa-camera"></i>
            <span>æ‘„åƒå¤´</span>
        </div>
        <div class="menu-item" onclick="showNotification('å¯åŠ¨AIåŠ©æ‰‹')">
            <i class="fas fa-robot"></i>
            <span>AIåŠ©æ‰‹</span>
        </div>
        <div class="menu-item" onclick="toggleMusic()">
            <i class="fas fa-music"></i>
            <span>éŸ³ä¹</span>
        </div>
        <div class="menu-item" onclick="toggleAC()">
            <i class="fas fa-snowflake"></i>
            <span>ç©ºè°ƒ</span>
        </div>
    </div>

    <div class="voice-indicator" id="voice-indicator">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="white">
            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
        </svg>
    </div>

    <div class="voice-panel" id="voice-panel">
        <h3 style="color: #00ffff; margin-bottom: 15px;">ğŸ¤ è¯­éŸ³æ§åˆ¶é¢æ¿</h3>
        <div class="voice-status" id="voice-status">å‡†å¤‡å°±ç»ª - ç‚¹å‡»å½•éŸ³æŒ‰é’®å¼€å§‹</div>
        <input type="text" class="voice-input" id="voice-input" placeholder="æˆ–ç›´æ¥è¾“å…¥æŒ‡ä»¤ï¼Œå¦‚ï¼šæ‰“å¼€ç©ºè°ƒã€æ’­æ”¾éŸ³ä¹ç­‰">
        <div class="voice-buttons" id="voice-buttons">
            <button class="voice-btn" onclick="startRecording()" id="record-btn">
                <i class="fas fa-microphone"></i> å¼€å§‹å½•éŸ³
            </button>
            <button class="voice-btn" onclick="sendVoiceCommand()" id="send-btn">
                <i class="fas fa-paper-plane"></i> å‘é€æŒ‡ä»¤
            </button>
            <button class="voice-btn" onclick="closeVoicePanel()" id="close-btn">
                <i class="fas fa-times"></i> å…³é—­
            </button>
        </div>
    </div>

    <div class="notification" id="notification">
        æ“ä½œæˆåŠŸï¼
    </div>

    <!-- ğŸ§ª æµ‹è¯•æ³¨æ„åŠ›åç¦»è­¦å‘ŠæŒ‰é’® -->
    <button class="test-warning-btn" onclick="testAttentionWarning()" title="æµ‹è¯•æ³¨æ„åŠ›åç¦»è­¦å‘Š">
        <i class="fas fa-exclamation-triangle"></i> æµ‹è¯•è­¦å‘Š
    </button>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="warn1-audio" preload="auto">
        <source src="/static/audio/warn1.mp3" type="audio/mpeg">
        <source src="/static/audio/warn1.wav" type="audio/wav">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>

    <audio id="warn2-audio" preload="auto">
        <source src="/static/audio/warn2.mp3" type="audio/mpeg">
        <source src="/static/audio/warn2.wav" type="audio/wav">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>

    <!-- æ³¨æ„åŠ›åç¦»è­¦å‘Šå¼¹çª— -->
    <div class="attention-warning-modal" id="attention-warning-modal">
        <div class="attention-warning-content">
            <div class="warning-icon">âš ï¸</div>
            <h2>æ³¨æ„åŠ›åç¦»è­¦å‘Š</h2>
            <p id="attention-warning-message">è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹</p>
            <div class="warning-buttons">
                <button class="attention-response-btn" onclick="respondToAttentionWarning()">
                    æˆ‘å·²æ³¨æ„
                </button>
            </div>
            <div class="attention-timer">
                <span id="attention-countdown">10</span> ç§’åå°†å‡çº§è­¦å‘Š
            </div>
        </div>
    </div>

   <script>
    let currentIndex = 0;
    const slides = document.querySelectorAll('.card');
    const totalSlides = slides.length;
    let isListening = false;
    let isRecording = false;
    let isProcessing = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let recordingTimeout = null;
    
    let vehicleState = {
        ac: { status: "å…³é—­", temperature: 24, mode: "åˆ¶å†·" },
        music: { status: "æš‚åœ", volume: 40 },
        navigation: { status: "å…³é—­", destination: "" },
        camera: { status: "å…³é—­" },
        media: { status: "æš‚åœ", volume: 70 }
    };

    // æµ‹è¯•æ³¨æ„åŠ›åç¦»è­¦å‘ŠåŠŸèƒ½æ·»åŠ ä¹˜å®¢æ£€æŸ¥
    async function testAttentionWarning() {
        console.log('ğŸ§ª æµ‹è¯•æ³¨æ„åŠ›åç¦»è­¦å‘Š');
        
        // ğŸ”§ ç®€å•æ£€æŸ¥ï¼šå¦‚æœæ˜¯ä¹˜å®¢ï¼Œæç¤ºæƒé™ä¸è¶³
        const userRole = "{{ role }}";
        if (userRole === 'passenger') {
            showNotification('ä¹˜å®¢æ¨¡å¼ä¸‹æ— éœ€æ³¨æ„åŠ›åç¦»è­¦å‘Š', 'info');
            addLogEntry('ğŸ‘¤ ä¹˜å®¢ç”¨æˆ·å°è¯•æµ‹è¯•æ³¨æ„åŠ›è­¦å‘Š');
            return;
        }
        
        // åŸæœ‰çš„æµ‹è¯•é€»è¾‘ä¿æŒä¸å˜
        try {
            const response = await fetch('/api/attention_deviation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                addLogEntry('ğŸ§ª æ³¨æ„åŠ›åç¦»è­¦å‘Šæµ‹è¯•å·²å¯åŠ¨');
                showNotification('æ³¨æ„åŠ›åç¦»è­¦å‘Šæµ‹è¯•å·²å¯åŠ¨', 'info');
            } else {
                addLogEntry(`âŒ æµ‹è¯•å¤±è´¥: ${result.message}`);
                showNotification('æµ‹è¯•å¤±è´¥', 'error');
            }
            
        } catch (error) {
            console.error('æµ‹è¯•æ³¨æ„åŠ›åç¦»è­¦å‘Šå¤±è´¥:', error);
            addLogEntry(`âŒ æµ‹è¯•å¼‚å¸¸: ${error.message}`);
            showNotification('æµ‹è¯•å¼‚å¸¸', 'error');
        }
    }


    // æ›´æ–°è¯­éŸ³çŠ¶æ€æ˜¾ç¤º
    function updateVoiceStatus(message, type = 'normal') {
        const statusElement = document.getElementById('voice-status');
        statusElement.textContent = message;
        
        statusElement.className = 'voice-status';
        if (type === 'processing') {
            statusElement.classList.add('processing');
        } else if (type === 'error') {
            statusElement.classList.add('error');
        }
    }

    // å¤„ç†è¯­éŸ³æŒ‡ä»¤ç»“æœ - å…³é”®å‡½æ•°
    function handleCommandResult(result) {
        console.log('å¤„ç†æŒ‡ä»¤ç»“æœ:', result);
         
         // æ£€æŸ¥æ˜¯å¦æ˜¯æ³¨æ„åŠ›åç¦»è­¦å‘Š
        if (result.è­¦å‘Šç±»å‹ === 'attention_deviation' && result.éœ€è¦éŸ³é¢‘è­¦å‘Š) {
            const warningMessage = result.è­¦å‘Šæ¶ˆæ¯ || "è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹";
            showAttentionWarning(warningMessage);
            return; // æ³¨æ„åŠ›è­¦å‘Šæœ‰ç‰¹æ®Šå¤„ç†ï¼Œä¸èµ°å¸¸è§„æµç¨‹
        }

        if (result.success) {
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            showNotification(result.message, 'success');
            addLogEntry(`âœ… ${result.message}`);
            updateVoiceStatus(`âœ… ${result.message}`, 'normal');
            
            // æ›´æ–°è½¦è¾†çŠ¶æ€
            if (result.status_changes) {
                Object.assign(vehicleState, result.status_changes);
            }
            
            // æ‰§è¡ŒUIæ›´æ–°
            if (result.ui_updates) {
                executeUIUpdates(result.ui_updates);
            }
            
            // æ ¹æ®åŠ¨ä½œç±»å‹æ‰§è¡Œç‰¹å®šæ›´æ–°
            switch(result.action) {
                case 'ac_on':
                case 'ac_off':
                case 'ac_temp':
                    updateACUI();
                    break;
                case 'music_play':
                case 'music_pause':
                case 'music_volume':
                    updateMusicUI();
                    break;
                case 'nav_on':
                case 'nav_off':
                case 'nav_destination':
                    updateNavigationUI();
                    break;
                case 'camera_on':
                case 'camera_off':
                    updateCameraUI();
                    break;
            }
        } else {
            // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
            showNotification(result.message, 'error');
            addLogEntry(`âŒ ${result.message}`);
            updateVoiceStatus(`âŒ ${result.message}`, 'error');
        }
    }

    // æ‰§è¡ŒUIæ›´æ–° - å…³é”®å‡½æ•°
    function executeUIUpdates(updates) {
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºç¯
        if (updates.ac_indicator) {
            updateStatusIndicator('ac-indicator', updates.ac_indicator === 'on');
        }
        if (updates.music_indicator) {
            updateStatusIndicator('music-indicator', updates.music_indicator === 'on');
        }
        if (updates.nav_indicator) {
            updateStatusIndicator('nav-indicator', updates.nav_indicator === 'on');
        }
        if (updates.camera_indicator) {
            updateStatusIndicator('camera-indicator', updates.camera_indicator === 'on');
        }
        
        // æ›´æ–°æ¸©åº¦æ˜¾ç¤º
        if (updates.ac_temp) {
            const tempDisplay = document.getElementById('ac-temp');
            const tempSlider = document.getElementById('temp-slider');
            if (tempDisplay) tempDisplay.textContent = `æ¸©åº¦: ${updates.ac_temp}Â°C`;
            if (tempSlider) tempSlider.value = updates.ac_temp;

            // ä¿å­˜åˆ°æ•°æ®åº“
            updateHabit(0, updates.ac_temp);
        }
        
        // æ›´æ–°éŸ³é‡æ˜¾ç¤º
        if (updates.music_volume) {
            const volumeDisplay = document.getElementById('music-volume');
            const volumeSlider = document.getElementById('music-slider');
            if (volumeDisplay) volumeDisplay.textContent = `éŸ³é‡: ${updates.music_volume}%`;
            if (volumeSlider) volumeSlider.value = updates.music_volume;

            // ä¿å­˜åˆ°æ•°æ®åº“
            updateHabit(1, updates.ac_temp);
        }
        
        // æ›´æ–°å¯¼èˆªç›®çš„åœ°
        if (updates.nav_destination) {
            const destDisplay = document.getElementById('nav-destination');
            if (destDisplay) destDisplay.textContent = updates.nav_destination;
        }
        
        // é«˜äº®ç›¸å…³å¡ç‰‡
        if (updates.highlight_card) {
            highlightCardByType(updates.highlight_card);
        }
    }

    // æ ¹æ®ç±»å‹é«˜äº®å¡ç‰‡
    function highlightCardByType(type) {
        const cardMap = {
            'ac': '.card:nth-child(9)',
            'music': '.card:nth-child(8)',
            'navigation': '.card:nth-child(2)',
            'camera': '.card:nth-child(6)',
            'media': '.card:nth-child(3)'
        };
        
        if (cardMap[type]) {
            highlightCard(cardMap[type]);
        }
    }

    // åˆå§‹åŒ–å½•éŸ³åŠŸèƒ½
    async function initAudioRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 16000
                } 
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                audioChunks = [];
                await sendAudioToBackend(audioBlob);
            };
            
            console.log('âœ… å½•éŸ³åŠŸèƒ½åˆå§‹åŒ–æˆåŠŸ');
            updateVoiceStatus('å½•éŸ³åŠŸèƒ½å°±ç»ª - å¯ä»¥å¼€å§‹è¯­éŸ³äº¤äº’', 'normal');
            return true;
        } catch (error) {
            console.error('âŒ å½•éŸ³åŠŸèƒ½åˆå§‹åŒ–å¤±è´¥:', error);
            updateVoiceStatus('å½•éŸ³åŠŸèƒ½ä¸å¯ç”¨ - è¯·æ£€æŸ¥éº¦å…‹é£æƒé™', 'error');
            showNotification('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
            return false;
        }
    }

    // å¼€å§‹å½•éŸ³
    async function startRecording() {
        if (isProcessing) {
            showNotification('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'info');
            return;
        }

        if (isRecording) {
            stopRecording();
            return;
        }

        if (!mediaRecorder) {
            const success = await initAudioRecording();
            if (!success) return;
        }
        
        try {
            audioChunks = [];
            mediaRecorder.start();
            isRecording = true;
            
            // æ›´æ–°UI
            const voiceIndicator = document.getElementById('voice-indicator');
            const recordBtn = document.getElementById('record-btn');
            
            voiceIndicator.classList.add('recording');
            recordBtn.classList.add('recording');
            recordBtn.innerHTML = '<i class="fas fa-stop"></i> åœæ­¢å½•éŸ³';
            
            updateVoiceStatus('ğŸ¤ æ­£åœ¨å½•éŸ³... è¯·æ¸…æ™°è¯´è¯ï¼ˆæœ€é•¿10ç§’ï¼‰', 'processing');
            addLogEntry('ğŸ¤ å¼€å§‹å½•éŸ³ï¼Œè¯·è¯´è¯...');
            
            // 10ç§’åè‡ªåŠ¨åœæ­¢å½•éŸ³
            recordingTimeout = setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                    addLogEntry('â° å½•éŸ³æ—¶é—´è¾¾åˆ°ä¸Šé™ï¼Œè‡ªåŠ¨åœæ­¢');
                }
            }, 10000);
            
        } catch (error) {
            console.error('å½•éŸ³å¯åŠ¨å¤±è´¥:', error);
            updateVoiceStatus('å½•éŸ³å¯åŠ¨å¤±è´¥', 'error');
            showNotification('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™', 'error');
            resetRecordingUI();
        }
    }

    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            resetRecordingUI();
            updateVoiceStatus('ğŸ”„ å½•éŸ³å®Œæˆï¼Œæ­£åœ¨è¯†åˆ«...', 'processing');
            addLogEntry('ğŸ“ å½•éŸ³ç»“æŸï¼Œå¼€å§‹Whisperè¯†åˆ«...');
        }
    }

    function resetRecordingUI() {
        const voiceIndicator = document.getElementById('voice-indicator');
        const recordBtn = document.getElementById('record-btn');
        
        voiceIndicator.classList.remove('recording');
        recordBtn.classList.remove('recording');
        recordBtn.innerHTML = '<i class="fas fa-microphone"></i> å¼€å§‹å½•éŸ³';
    }

    // å‘é€éŸ³é¢‘åˆ°åç«¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    async function sendAudioToBackend(audioBlob) {
        if (isProcessing) return;
        isProcessing = true;
        
        try {
            console.log('ğŸ¤ å‘é€éŸ³é¢‘åˆ°Whisperç³»ç»Ÿï¼Œå¤§å°:', audioBlob.size, 'bytes');
            
            const formData = new FormData();
            formData.append('audio', audioBlob, 'web_recording.webm');
            
            updateVoiceStatus('ğŸ”„ æ­£åœ¨ä½¿ç”¨Whisperè¯†åˆ«...', 'processing');
            
            const response = await fetch('/api/voice_recognition', {
                method: 'POST',
                body: formData,
                signal: AbortSignal.timeout(20000) // 20ç§’è¶…æ—¶
            });
            
            if (!response.ok) {
                throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
            }
            
            const result = await response.json();
            console.log('ğŸ¯ Whisperè¯†åˆ«å“åº”:', result);
            
            if (result.status === 'success') {
                const recognizedText = result.text;
                
                // åœ¨è¾“å…¥æ¡†ä¸­æ˜¾ç¤ºè¯†åˆ«ç»“æœ
                const voiceInput = document.getElementById('voice-input');
                voiceInput.value = recognizedText;
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showNotification(`âœ… è¯†åˆ«æˆåŠŸ: ${recognizedText}`, 'success');
                addLogEntry(`âœ… Whisperè¯†åˆ«ç»“æœ: ${recognizedText}`);
                updateVoiceStatus(`âœ… è¯†åˆ«æˆåŠŸ: ${recognizedText}`, 'normal');
                setTimeout(() => {
                sendTextCommand(recognizedText);
                }, 300);
                // å¤„ç†æŒ‡ä»¤ç»“æœ
                if (result.command_result) {
                    setTimeout(() => {
                        handleCommandResult(result.command_result);
                    }, 500);
                }
                
            } else {
                console.warn('Whisperè¯†åˆ«å¤±è´¥:', result.message);
                showNotification(`è¯†åˆ«å¤±è´¥: ${result.message}`, 'error');
                addLogEntry(`âŒ Whisperè¯†åˆ«å¤±è´¥: ${result.message}`);
                updateVoiceStatus(`âŒ è¯†åˆ«å¤±è´¥: ${result.message}`, 'error');
            }
            
        } catch (error) {
            console.error('Whisperè¯†åˆ«é”™è¯¯:', error);
            
            if (error.name === 'TimeoutError') {
                showNotification('Whisperè¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
                addLogEntry('â° Whisperè¯†åˆ«è¶…æ—¶');
                updateVoiceStatus('â° è¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
            } else if (error.message.includes('ç½‘ç»œ')) {
                showNotification('ç½‘ç»œè¿æ¥å¼‚å¸¸', 'error');
                addLogEntry('ğŸ“¡ ç½‘ç»œè¿æ¥é—®é¢˜');
                updateVoiceStatus('ğŸ“¡ ç½‘ç»œè¿æ¥å¼‚å¸¸', 'error');
            } else {
                showNotification('Whisperè¯†åˆ«æœåŠ¡å¼‚å¸¸ï¼Œè¯·é‡è¯•', 'error');
                addLogEntry(`ğŸ”§ WhisperæœåŠ¡å¼‚å¸¸: ${error.message}`);
                updateVoiceStatus('ğŸ”§ æœåŠ¡å¼‚å¸¸ï¼Œè¯·é‡è¯•', 'error');
            }
        } finally {
            isProcessing = false;
        }
    }
    function sendTextCommand(command) {
    if (!command) return;
    if (isProcessing) return;

    isProcessing = true;
    updateVoiceStatus('ğŸ”„ æ­£åœ¨å¤„ç†æŒ‡ä»¤...', 'processing');

    fetch('/api/test_voice', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: command })
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success' && result.command_result) {
            handleCommandResult(result.command_result);
        } else {
            showNotification(result.message || 'âŒ æŒ‡ä»¤æ‰§è¡Œå¤±è´¥', 'error');
            addLogEntry(`âŒ ${result.message}`);
            updateVoiceStatus(`âŒ ${result.message}`, 'error');
        }
    })
    .catch(err => {
        showNotification('âŒ ç½‘ç»œå¼‚å¸¸ï¼ŒæŒ‡ä»¤æœªå‘é€', 'error');
        updateVoiceStatus('âŒ ç½‘ç»œé”™è¯¯', 'error');
    })
    .finally(() => {
        isProcessing = false;
    });
   }

    function showSlide(index) {
        const slider = document.getElementById('card-slider');
        slider.style.transform = `translateX(${-index * 50}%)`;
    }

    function nextSlide() {
        if (currentIndex < totalSlides - 2) {
            currentIndex++;
            showSlide(currentIndex);
        }
    }

    function prevSlide() {
        if (currentIndex > 0) {
            currentIndex--;
            showSlide(currentIndex);
        }
    }

    // ä¿®æ”¹showNotificationå‡½æ•°ï¼Œæ”¯æŒä¸åŒç±»å‹çš„æ¶ˆæ¯
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„æ ·å¼
        if (type === 'error') {
            notification.style.background = 'linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 75, 87, 0.9))';
            notification.style.color = '#fff';
        } else if (type === 'info') {
            notification.style.background = 'linear-gradient(135deg, rgba(255, 193, 7, 0.9), rgba(255, 235, 59, 0.9))';
            notification.style.color = '#000';
        } else {
            notification.style.background = 'linear-gradient(135deg, rgba(0, 255, 255, 0.9), rgba(106, 183, 255, 0.9))';
            notification.style.color = '#000';
        }
        
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // ä¿®æ”¹çŠ¶æ€æŒ‡ç¤ºå™¨æ›´æ–°å‡½æ•°ï¼Œæ·»åŠ åŠ¨ç”»æ•ˆæœ
    function updateStatusIndicator(elementId, isActive) {
        const indicator = document.getElementById(elementId);
        if (indicator) {
            if (isActive) {
                indicator.classList.remove('status-off');
                // æ·»åŠ æ¿€æ´»åŠ¨ç”»
                indicator.style.animation = 'statusChange 0.5s ease';
            } else {
                indicator.classList.add('status-off');
                indicator.style.animation = 'statusChange 0.5s ease';
            }
            
            // æ¸…é™¤åŠ¨ç”»
            setTimeout(() => {
                indicator.style.animation = '';
            }, 500);
        }
    }

    function highlightCard(cardSelector) {
        document.querySelectorAll('.card').forEach(card => {
            card.classList.remove('active');
        });
        
        const targetCard = document.querySelector(cardSelector);
        if (targetCard) {
            targetCard.classList.add('active');
            setTimeout(() => {
                targetCard.classList.remove('active');
            }, 3000);
        }
    }

    function toggleAC() {
        vehicleState.ac.status = vehicleState.ac.status === "å¼€å¯" ? "å…³é—­" : "å¼€å¯";
        updateACUI();
        sendCommandToBackend(vehicleState.ac.status === "å¼€å¯" ? "æ‰“å¼€ç©ºè°ƒ" : "å…³é—­ç©ºè°ƒ");
    }

    function updateACUI() {
        const indicator = document.getElementById('ac-indicator');
        const tempDisplay = document.getElementById('ac-temp');
        const modeDisplay = document.getElementById('ac-mode');
        const tempSlider = document.getElementById('temp-slider');
        
        updateStatusIndicator('ac-indicator', vehicleState.ac.status === "å¼€å¯");
        tempDisplay.textContent = `æ¸©åº¦: ${vehicleState.ac.temperature}Â°C`;
        modeDisplay.textContent = `æ¨¡å¼: ${vehicleState.ac.mode}`;
        tempSlider.value = vehicleState.ac.temperature;
        
        highlightCard('.card:nth-child(9)');
    }

    function toggleMusic() {
        vehicleState.music.status = vehicleState.music.status === "æ’­æ”¾" ? "æš‚åœ" : "æ’­æ”¾";
        updateMusicUI();
        sendCommandToBackend(vehicleState.music.status === "æ’­æ”¾" ? "æ’­æ”¾éŸ³ä¹" : "æš‚åœéŸ³ä¹");
    }

    function updateMusicUI() {
        const indicator = document.getElementById('music-indicator');
        const volumeDisplay = document.getElementById('music-volume');
        const volumeSlider = document.getElementById('music-slider');
        
        updateStatusIndicator('music-indicator', vehicleState.music.status === "æ’­æ”¾");
        volumeDisplay.textContent = `éŸ³é‡: ${vehicleState.music.volume}%`;
        volumeSlider.value = vehicleState.music.volume;
        
        highlightCard('.card:nth-child(8)');
    }

    function toggleMedia() {
        vehicleState.media.status = vehicleState.media.status === "æ’­æ”¾" ? "æš‚åœ" : "æ’­æ”¾";
        updateMediaUI();
    }

    function updateMediaUI() {
        const indicator = document.getElementById('media-indicator');
        const volumeDisplay = document.getElementById('media-volume');
        const volumeSlider = document.getElementById('volume-slider');
        
        updateStatusIndicator('media-indicator', vehicleState.media.status === "æ’­æ”¾");
        volumeDisplay.textContent = `éŸ³é‡: ${vehicleState.media.volume}%`;
        volumeSlider.value = vehicleState.media.volume;
        
        highlightCard('.card:nth-child(3)');
    }

    function toggleNavigation() {
        vehicleState.navigation.status = vehicleState.navigation.status === "å¼€å¯" ? "å…³é—­" : "å¼€å¯";
        updateNavigationUI();
        sendCommandToBackend(vehicleState.navigation.status === "å¼€å¯" ? "å¼€å¯å¯¼èˆª" : "å…³é—­å¯¼èˆª");
    }

    function updateNavigationUI() {
        const indicator = document.getElementById('nav-indicator');
        const destDisplay = document.getElementById('nav-destination');
        
        updateStatusIndicator('nav-indicator', vehicleState.navigation.status === "å¼€å¯");
        destDisplay.textContent = vehicleState.navigation.destination || "æš‚æ— ç›®çš„åœ°";
        
        highlightCard('.card:nth-child(2)');
    }

    function toggleCamera() {
        vehicleState.camera.status = vehicleState.camera.status === "å¼€å¯" ? "å…³é—­" : "å¼€å¯";
        updateCameraUI();
        showNotification(`æ‘„åƒå¤´å·²${vehicleState.camera.status}`);
    }

    function updateCameraUI() {
        updateStatusIndicator('camera-indicator', vehicleState.camera.status === "å¼€å¯");
        highlightCard('.card:nth-child(6)');
    }

    function toggleVoiceListening() {
        const indicator = document.getElementById('voice-indicator');
        const panel = document.getElementById('voice-panel');
        
        if (!isListening) {
            panel.classList.add('show');
            updateVoiceStatus('è¯­éŸ³é¢æ¿å·²æ‰“å¼€ - ç‚¹å‡»å½•éŸ³æŒ‰é’®å¼€å§‹', 'normal');
            showNotification('ğŸ¤ è¯­éŸ³æ§åˆ¶é¢æ¿å·²æ‰“å¼€', 'info');
            isListening = true;
        } else {
            panel.classList.remove('show');
            if (isRecording) {
                stopRecording();
            }
            showNotification('è¯­éŸ³æ§åˆ¶å·²å…³é—­', 'info');
            isListening = false;
        }
    }

    // ä¿®æ”¹å‘é€è¯­éŸ³æŒ‡ä»¤å‡½æ•°ï¼Œæ·»åŠ æŒ‡ä»¤ç»“æœå¤„ç†
    async function sendVoiceCommand() {
        const input = document.getElementById('voice-input');
        const command = input.value.trim();
        
        if (command) {
            if (isProcessing) {
                showNotification('æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...', 'info');
                return;
            }

            isProcessing = true;
            updateVoiceStatus('ğŸ”„ æ­£åœ¨å¤„ç†æ–‡æœ¬æŒ‡ä»¤...', 'processing');

            try {
                const response = await fetch('/api/test_voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: command })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // å¤„ç†æŒ‡ä»¤ç»“æœ
                    if (result.command_result) {
                        handleCommandResult(result.command_result);
                    }
                } else {
                    showNotification(result.message, 'error');
                    addLogEntry(`âŒ ${result.message}`);
                    updateVoiceStatus(`âŒ ${result.message}`, 'error');
                }
                
                input.value = '';
                
            } catch (error) {
                showNotification('å‘é€å¤±è´¥', 'error');
                addLogEntry(`âŒ å‘é€å¤±è´¥: ${error.message}`);
                updateVoiceStatus('âŒ å‘é€å¤±è´¥', 'error');
            } finally {
                isProcessing = false;
            }
        } else {
            showNotification('è¯·è¾“å…¥è¯­éŸ³æŒ‡ä»¤', 'info');
        }
    }

    function closeVoicePanel() {
        document.getElementById('voice-panel').classList.remove('show');
        if (isRecording) {
            stopRecording();
        }
        isListening = false;
        updateVoiceStatus('è¯­éŸ³é¢æ¿å·²å…³é—­', 'normal');
    }

    async function sendCommandToBackend(command) {
        try {
            const response = await fetch('/api/test_voice', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ text: command })
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                if (result.command_result) {
                    handleCommandResult(result.command_result);
                }
                addLogEntry(`âœ… ${result.message}`);
            } else {
                addLogEntry(`âŒ ${result.message}`);
            }
        } catch (error) {
            addLogEntry(`âŒ å‘é€å¤±è´¥: ${error.message}`);
        }
    }

    function initSliders() {
        const volumeSlider = document.getElementById('volume-slider');
        const musicSlider = document.getElementById('music-slider');
        const tempSlider = document.getElementById('temp-slider');
        
        volumeSlider.addEventListener('input', function() {
            vehicleState.media.volume = parseInt(this.value);
            document.getElementById('media-volume').textContent = `éŸ³é‡: ${this.value}%`;
            showNotification(`åª’ä½“éŸ³é‡è°ƒæ•´è‡³: ${this.value}%`, 'info');

            // // ä¿å­˜åˆ°æ•°æ®åº“
            // updateHabit(1, this.value);
        });
        
        musicSlider.addEventListener('input', function() {
            vehicleState.music.volume = parseInt(this.value);
            document.getElementById('music-volume').textContent = `éŸ³é‡: ${this.value}%`;
            sendCommandToBackend(`éŸ³é‡è°ƒåˆ°${this.value}`);
            // // ä¿å­˜åˆ°æ•°æ®åº“
            // updateHabit(1, this.value);
        });
        
        tempSlider.addEventListener('input', function() {
            vehicleState.ac.temperature = parseInt(this.value);
            document.getElementById('ac-temp').textContent = `æ¸©åº¦: ${this.value}Â°C`;
            sendCommandToBackend(`è°ƒåˆ°${this.value}åº¦`);
            // ä¿å­˜åˆ°æ•°æ®åº“
            // updateHabit(0, this.value);
        });
    }

function updateHabit(tp, val) {
    const username = "{{ username }}";
    console.log("ç”¨æˆ·åæ˜¯:", "{{ username }}");

    const bodyData = {
        username: username
    };

    if (tp === 0) {
        console.log(`ğŸŸ¡ [è°ƒè¯•] å°è¯•æ›´æ–°æ¸©åº¦ä¸º ${val}`);
        bodyData.temperature = val;
    } else if (tp === 1) {
        console.log(`ğŸŸ¡ [è°ƒè¯•] å°è¯•æ›´æ–°éŸ³é‡ä¸º ${val}`);
        bodyData.music = val;
    } else {
        console.warn("âš ï¸ [è°ƒè¯•] updateHabit å‚æ•° tp éæ³•ï¼Œå¿…é¡»ä¸º 0 æˆ– 1");
        return;
    }

    console.log('ğŸ“¤ [è°ƒè¯•] å‘é€æ•°æ®:', bodyData);

    fetch('/logs/update_habit', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(bodyData)
    })
    .then(async res => {
        const data = await res.json();
        if (res.ok && data.success) {
            console.log(`âœ… [æˆåŠŸ] ${tp === 0 ? 'æ¸©åº¦' : 'éŸ³é‡'} = ${val} å·²ä¿å­˜åˆ°æ•°æ®åº“`);
        } else {
            console.warn(`âŒ [å¤±è´¥] çŠ¶æ€ç : ${res.status}, å“åº”:`, data);
        }
    })
    .catch(err => {
        console.error('âŒ [å¼‚å¸¸] ä¸åç«¯é€šä¿¡å¤±è´¥:', err);
    });
}

    function updateTime() {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        document.getElementById('time-display').textContent = timeStr;
    }

    function updateUIFromBackend(data) {
        console.log('æ”¶åˆ°åç«¯æ•°æ®:', data);
        
        if (data.vehicle_state) {
            vehicleState = { ...vehicleState, ...data.vehicle_state };
            
            if (data.vehicle_state.ac) {
                updateACUI();
            }
            
            if (data.vehicle_state.music) {
                updateMusicUI();
            }
            
            if (data.vehicle_state.navigation) {
                updateNavigationUI();
            }
        }
    }

    function initGauge() {
        var myChart = echarts.init(document.getElementById('gauge'));
        var option = {
            backgroundColor: 'transparent',
            tooltip: {
                formatter: '{a} <br/>{c} {b}'
            },
            series: [
                {
                    name: 'é€Ÿåº¦',
                    type: 'gauge',
                    min: 0,
                    max: 220,
                    splitNumber: 11,
                    radius: '85%',
                    axisLine: {
                        lineStyle: {
                            color: [[0.09, 'lime'], [0.82, '#1e90ff'], [1, '#ff4500']],
                            width: 3,
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    axisLabel: {
                        fontWeight: 'bolder',
                        color: '#fff',
                        shadowColor: '#fff',
                        shadowBlur: 10
                    },
                    axisTick: {
                        length: 15,
                        lineStyle: {
                            color: 'auto',
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    splitLine: {
                        length: 25,
                        lineStyle: {
                            width: 3,
                            color: '#fff',
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    pointer: {
                        shadowColor: '#fff',
                        shadowBlur: 5
                    },
                    title: {
                        textStyle: {
                            fontWeight: 'bolder',
                            fontSize: 14,
                            fontStyle: 'italic',
                            color: '#fff',
                            shadowColor: '#fff',
                            shadowBlur: 10
                        }
                    },
                    detail: {
                        backgroundColor: 'rgba(30,144,255,0.8)',
                        borderWidth: 1,
                        borderColor: '#fff',
                        shadowColor: '#fff',
                        shadowBlur: 5,
                        offsetCenter: [0, '50%'],
                        padding: [1, 1],
                        textStyle: {
                            fontWeight: 'bolder',
                            color: '#fff',
                            fontSize: 14
                        }
                    },
                    data: [{value: 40, name: 'km/h'}]
                }
            ]
        };
        
        setInterval(function() {
            option.series[0].data[0].value = (Math.random() * 100).toFixed(2) - 0;
            myChart.setOption(option);
        }, 2000);
        
        myChart.setOption(option);
    }

    // æ³¨æ„åŠ›åç¦»è­¦å‘Šç›¸å…³å˜é‡
    let attentionWarningActive = false;
    let attentionWarningTimer = null;
    let attentionCountdown = 10;
    let attentionCountdownInterval = null;
    let warn1Audio = null;
    let warn2Audio = null;

    // åˆå§‹åŒ–éŸ³é¢‘
    function initAttentionAudio() {
        warn1Audio = document.getElementById('warn1-audio');
        warn2Audio = document.getElementById('warn2-audio');
        
        // è®¾ç½®éŸ³é¢‘å±æ€§
        if (warn1Audio) {
            warn1Audio.volume = 0.8;
            warn1Audio.loop = false;
        }
        
        if (warn2Audio) {
            warn2Audio.volume = 1.0;
            warn2Audio.loop = true; // ç¬¬äºŒä¸ªè­¦å‘ŠéŸ³é¢‘å¾ªç¯æ’­æ”¾
        }
        
        console.log('ğŸ”Š æ³¨æ„åŠ›è­¦å‘ŠéŸ³é¢‘åˆå§‹åŒ–å®Œæˆ');
    }

    
    // å‡½æ•°å¼€å¤´æ·»åŠ ä¹˜å®¢æ£€æŸ¥
    function showAttentionWarning(message = "è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹") {
        // ğŸ”§ ç®€å•æ£€æŸ¥ï¼šå¦‚æœæ˜¯ä¹˜å®¢ï¼Œç›´æ¥è¿”å›ä¸æ˜¾ç¤ºè­¦å‘Š
        const userRole = "{{ role }}";
        if (userRole === 'passenger') {
            console.log('ğŸ‘¤ ä¹˜å®¢ç”¨æˆ·ï¼Œè·³è¿‡æ³¨æ„åŠ›åç¦»è­¦å‘Š');
            addLogEntry('ğŸ‘¤ ä¹˜å®¢æ¨¡å¼ï¼Œæ— éœ€æ³¨æ„åŠ›åç¦»è­¦å‘Š');
            return;
        }
        
        // åŸæœ‰çš„è­¦å‘Šé€»è¾‘ä¿æŒä¸å˜
        if (attentionWarningActive) {
            console.log('âš ï¸ æ³¨æ„åŠ›è­¦å‘Šå·²æ¿€æ´»ï¼Œè·³è¿‡é‡å¤è­¦å‘Š');
            return;
        }
        
        attentionWarningActive = true;
        console.log('ğŸš¨ æ˜¾ç¤ºæ³¨æ„åŠ›åç¦»è­¦å‘Š');
        
        // æ˜¾ç¤ºè­¦å‘Šå¼¹çª—
        const modal = document.getElementById('attention-warning-modal');
        const messageElement = document.getElementById('attention-warning-message');
        
        messageElement.textContent = message;
        modal.classList.add('show');
        
        // æ’­æ”¾ç¬¬ä¸€ä¸ªè­¦å‘ŠéŸ³é¢‘
        playWarn1Audio();
        
        // å¼€å§‹å€’è®¡æ—¶
        startAttentionCountdown();
        
        // 10ç§’åå¦‚æœæ²¡æœ‰å“åº”ï¼Œæ’­æ”¾ç¬¬äºŒä¸ªè­¦å‘ŠéŸ³é¢‘
        attentionWarningTimer = setTimeout(() => {
            if (attentionWarningActive) {
                escalateAttentionWarning();
            }
        }, 10000);
        
        // è®°å½•æ—¥å¿—
        addLogEntry('ğŸš¨ æ³¨æ„åŠ›åç¦»è­¦å‘Šå·²è§¦å‘');
    }
    

    // æ’­æ”¾ç¬¬ä¸€ä¸ªè­¦å‘ŠéŸ³é¢‘
    function playWarn1Audio() {
        if (warn1Audio) {
            warn1Audio.currentTime = 0;
            warn1Audio.play().then(() => {
                console.log('ğŸ”Š æ’­æ”¾ç¬¬ä¸€ä¸ªè­¦å‘ŠéŸ³é¢‘');
                addLogEntry('ğŸ”Š æ’­æ”¾ç¬¬ä¸€çº§è­¦å‘ŠéŸ³é¢‘');
            }).catch(error => {
                console.error('æ’­æ”¾warn1éŸ³é¢‘å¤±è´¥:', error);
                addLogEntry('âŒ ç¬¬ä¸€çº§è­¦å‘ŠéŸ³é¢‘æ’­æ”¾å¤±è´¥');
            });
        }
    }

    // å‡çº§è­¦å‘Šï¼ˆæ’­æ”¾ç¬¬äºŒä¸ªéŸ³é¢‘ï¼‰
    function escalateAttentionWarning() {
        console.log('ğŸš¨ å‡çº§æ³¨æ„åŠ›è­¦å‘Š');
        
        // åœæ­¢ç¬¬ä¸€ä¸ªéŸ³é¢‘
        if (warn1Audio) {
            warn1Audio.pause();
            warn1Audio.currentTime = 0;
        }
        
        // æ’­æ”¾ç¬¬äºŒä¸ªè­¦å‘ŠéŸ³é¢‘ï¼ˆå¾ªç¯ï¼‰
        if (warn2Audio) {
            warn2Audio.currentTime = 0;
            warn2Audio.play().then(() => {
                console.log('ğŸ”Š æ’­æ”¾ç¬¬äºŒä¸ªè­¦å‘ŠéŸ³é¢‘ï¼ˆå¾ªç¯ï¼‰');
                addLogEntry('ğŸš¨ æ’­æ”¾ç¬¬äºŒçº§è­¦å‘ŠéŸ³é¢‘ï¼ˆå¾ªç¯ï¼‰');
            }).catch(error => {
                console.error('æ’­æ”¾warn2éŸ³é¢‘å¤±è´¥:', error);
                addLogEntry('âŒ ç¬¬äºŒçº§è­¦å‘ŠéŸ³é¢‘æ’­æ”¾å¤±è´¥');
            });
        }
        
        // æ›´æ–°ç•Œé¢æç¤º
        const messageElement = document.getElementById('attention-warning-message');
        messageElement.textContent = "ä¸¥é‡è­¦å‘Šï¼ç«‹å³æ³¨è§†å‰æ–¹ï¼";
        
        // éšè—å€’è®¡æ—¶
        const timerElement = document.querySelector('.attention-timer');
        timerElement.style.display = 'none';
    }

    // å¼€å§‹å€’è®¡æ—¶
    function startAttentionCountdown() {
        attentionCountdown = 10;
        updateCountdownDisplay();
        
        attentionCountdownInterval = setInterval(() => {
            attentionCountdown--;
            updateCountdownDisplay();
            
            if (attentionCountdown <= 0) {
                clearInterval(attentionCountdownInterval);
            }
        }, 1000);
    }

    // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
    function updateCountdownDisplay() {
        const countdownElement = document.getElementById('attention-countdown');
        if (countdownElement) {
            countdownElement.textContent = attentionCountdown;
        }
    }

    // å“åº”æ³¨æ„åŠ›è­¦å‘Š
    function respondToAttentionWarning() {
        console.log('âœ… ç”¨æˆ·å“åº”æ³¨æ„åŠ›è­¦å‘Š');
        
        // æ¸…é™¤è­¦å‘ŠçŠ¶æ€
        attentionWarningActive = false;
        
        // æ¸…é™¤è®¡æ—¶å™¨
        if (attentionWarningTimer) {
            clearTimeout(attentionWarningTimer);
            attentionWarningTimer = null;
        }
        
        if (attentionCountdownInterval) {
            clearInterval(attentionCountdownInterval);
            attentionCountdownInterval = null;
        }
        
        // åœæ­¢æ‰€æœ‰éŸ³é¢‘
        if (warn1Audio) {
            warn1Audio.pause();
            warn1Audio.currentTime = 0;
        }
        
        if (warn2Audio) {
            warn2Audio.pause();
            warn2Audio.currentTime = 0;
        }
        
        // éšè—è­¦å‘Šå¼¹çª—
        const modal = document.getElementById('attention-warning-modal');
        modal.classList.remove('show');
        
        // é‡ç½®ç•Œé¢
        const messageElement = document.getElementById('attention-warning-message');
        messageElement.textContent = "è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹";
        
        const timerElement = document.querySelector('.attention-timer');
        timerElement.style.display = 'block';
        
        // æ˜¾ç¤ºæˆåŠŸå“åº”æ¶ˆæ¯
        showNotification('âœ… æ³¨æ„åŠ›è­¦å‘Šå·²ç¡®è®¤', 'success');
        addLogEntry('âœ… ç”¨æˆ·å·²å“åº”æ³¨æ„åŠ›è­¦å‘Š');
    }

    // ğŸ”§ ä¿®å¤ç‰ˆæœ¬çš„EventSourceå¤„ç†å‡½æ•°
    function initEventSource() {
        const outputContent = document.getElementById("output-box");
        const eventSource = new EventSource("/stream");
        
        eventSource.onmessage = function(event) {
            console.log("ğŸ” [EventSource] åŸå§‹æ•°æ®ï¼š", event.data);
            
            try {
            const message = event.data;
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ¡æ‹³æ‰‹åŠ¿
            if (message.includes('æ¡æ‹³æ‰‹åŠ¿éŸ³ä¹æš‚åœ')) {
                console.log('æ£€æµ‹åˆ°æ¡æ‹³æ‰‹åŠ¿ï¼Œæš‚åœéŸ³ä¹');
                // æ›´æ–°éŸ³ä¹çŠ¶æ€
                vehicleState.music.status = "æš‚åœ";
                // æ›´æ–°UI
                updateMusicUI();
                // æ˜¾ç¤ºé€šçŸ¥
                showNotification('æ¡æ‹³æ‰‹åŠ¿è§¦å‘éŸ³ä¹æš‚åœ');
               
            }
            if((message.includes('ç«–èµ·å¤§æ‹‡æŒ‡è¡¨ç¤ºç¡®è®¤'))&&attentionWarningActive){
                respondToAttentionWarning()
            }
            if((message.includes('æ£€æµ‹åˆ°ç”¨æˆ·ç‚¹å¤´ï¼Œè¡¨ç¤ºç¡®è®¤'))&&attentionWarningActive){
                respondToAttentionWarning()
            }
            if (message.includes('æŒ¥æ‰‹è¡¨ç¤ºå¯åŠ¨è¯­éŸ³æœåŠ¡')) {
                showNotification('ğŸ‘‹ æ£€æµ‹åˆ°æŒ¥æ‰‹ï¼Œè¯­éŸ³åŠ©æ‰‹å·²æ¿€æ´»', 'info');
                 if (isRecording || isProcessing) {
                    showNotification('ğŸ¤ å·²åœ¨å½•éŸ³ä¸­ï¼Œè¯·ç¨åå†æŒ¥æ‰‹', 'info');
                    return;
                }
                // å¦‚æœæœªæ¿€æ´»è¯­éŸ³é¢æ¿ï¼Œåˆ™æ‰“å¼€
                if (!isListening) {
                    toggleVoiceListening();
                }

                // ç­‰å¾…é¢æ¿åŠ¨ç”»åŠ è½½å®Œæ¯•ï¼Œå†å¼€å§‹å½•éŸ³
                setTimeout(() => {
                    if (!isRecording) {
                        startRecording();  // è‡ªåŠ¨å¼€å§‹å½•éŸ³
                    }
                }, 500); // ç­‰å¾…é¢æ¿å±•å¼€åŠ¨ç”»ï¼ˆ300mså·¦å³ï¼‰
            }
            if (message.includes('æ£€æµ‹åˆ°ç”¨æˆ·æ‘‡å¤´ï¼Œå·²æ‹’ç»ç›¸å…³æ“ä½œ')) {
                if (isRecording) {
                    stopRecording();
                }
                closeVoicePanel();
                showNotification('ğŸ™… æ‘‡å¤´å–æ¶ˆ - å·²ç»ˆæ­¢è¯­éŸ³äº¤äº’', 'info');
                addLogEntry('ğŸ™… ç”¨æˆ·é€šè¿‡æ‘‡å¤´å–æ¶ˆäº†è¯­éŸ³æ“ä½œ');
            }

            // åœ¨æ—¥å¿—åŒºåŸŸæ˜¾ç¤ºæ¶ˆæ¯
            addLogEntry(`ğŸ“ ${message}`);
         
                const data = JSON.parse(event.data);
                console.log("ğŸ” [EventSource] è§£æåæ•°æ®ï¼š", data);
                console.log("ğŸ” [EventSource] æ•°æ®ç±»å‹ï¼š", typeof data);
                console.log("ğŸ” [EventSource] data.typeï¼š", data.type);
                console.log("ğŸ” [EventSource] data.command_resultï¼š", data.command_result);

                // ğŸ”§ ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ£€æŸ¥command_resultä¸­çš„æ³¨æ„åŠ›åç¦»è­¦å‘Š
                if (data.command_result && data.command_result.è­¦å‘Šç±»å‹ === 'attention_deviation') {
                    console.log('ğŸš¨ [EventSource] æ£€æµ‹åˆ°æ³¨æ„åŠ›åç¦»è­¦å‘Šï¼ˆä»command_resultï¼‰');
                    const warningMessage = data.command_result.è­¦å‘Šæ¶ˆæ¯ || "è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹";
                    showAttentionWarning(warningMessage);
                    addLogEntry(`ğŸš¨ ${data.content || 'æ³¨æ„åŠ›åç¦»è­¦å‘Š'}`);
                    return;
                }
                
                // ğŸ”§ ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ£€æŸ¥æ¶ˆæ¯ç±»å‹ä¸ºæ³¨æ„åŠ›è­¦å‘Š
                if (data.type === 'attention_warning') {
                    console.log('ğŸš¨ [EventSource] æ£€æµ‹åˆ°æ³¨æ„åŠ›åç¦»è­¦å‘Šï¼ˆä»typeï¼‰');
                    const warningMessage = data.command_result?.è­¦å‘Šæ¶ˆæ¯ || "è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹";
                    showAttentionWarning(warningMessage);
                    addLogEntry(`ğŸš¨ ${data.content}`);
                    return;
                }
                
                // ğŸ”§ ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šæ£€æŸ¥contentå†…å®¹åŒ…å«æ³¨æ„åŠ›åç¦»
                if (data.content && typeof data.content === 'string' && data.content.includes('æ³¨æ„åŠ›åç¦»')) {
                    console.log('ğŸš¨ [EventSource] æ£€æµ‹åˆ°æ³¨æ„åŠ›åç¦»è­¦å‘Šï¼ˆä»contentï¼‰');
                    showAttentionWarning("è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹");
                    addLogEntry(`ğŸš¨ ${data.content}`);
                    return;
                }
                
                // ğŸ”§ ç¬¬å››ä¼˜å…ˆçº§ï¼šå…¼å®¹æ€§æ£€æŸ¥ï¼Œå­—ç¬¦ä¸²æ•°æ®åŒ…å«æ³¨æ„åŠ›åç¦»
                if (typeof data === 'string' && data.includes('æ³¨æ„åŠ›åç¦»')) {
                    console.log('ğŸš¨ [EventSource] æ£€æµ‹åˆ°æ³¨æ„åŠ›åç¦»è­¦å‘Šï¼ˆä»å­—ç¬¦ä¸²ï¼‰');
                    showAttentionWarning("è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹");
                    addLogEntry(`ğŸš¨ ${data}`);
                    return;
                }
                


                // å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
                if (data.type === 'voice_command' || data.type === 'voice_recognition') {
                    addLogEntry(`ğŸ—£ï¸ ${data.content}`);
                    
                    // å¤„ç†æŒ‡ä»¤ç»“æœ
                    if (data.command_result) {
                        setTimeout(() => {
                            handleCommandResult(data.command_result);
                        }, 100);
                    }
                } else if (data.type === 'system_command') {
                    // ğŸ”§ å¤„ç†ç³»ç»ŸæŒ‡ä»¤
                    addLogEntry(`âš™ï¸ ${data.content}`);
                    
                    // å¤„ç†æŒ‡ä»¤ç»“æœ
                    if (data.command_result) {
                        setTimeout(() => {
                            handleCommandResult(data.command_result);
                        }, 100);
                    }
                } else if (data.content) {
                    addLogEntry(data.content);
                }
                
                // æ›´æ–°UIçŠ¶æ€
                updateUIFromBackend(data);
                
            } catch (e) {
                console.error("ğŸ”§ [EventSource] è§£æé”™è¯¯:", e);
                console.error("ğŸ”§ [EventSource] åŸå§‹æ•°æ®:", event.data);
                
                // ğŸ”§ å¤„ç†çº¯å­—ç¬¦ä¸²æ•°æ®ï¼ˆå…¼å®¹åŸç‰ˆï¼‰
                if (typeof event.data === 'string' && event.data.includes('æ³¨æ„åŠ›åç¦»')) {
                    console.log('ğŸš¨ [EventSource] æ£€æµ‹åˆ°æ³¨æ„åŠ›åç¦»è­¦å‘Šï¼ˆçº¯å­—ç¬¦ä¸²ï¼‰');
                    showAttentionWarning("è­¦å‘Šï¼è¯·æ³¨è§†å‰æ–¹");
                    addLogEntry(`ğŸš¨ ${event.data}`);
                    return;
                }
                
                addLogEntry(event.data);
            }
        };
        
        eventSource.onerror = function(err) {
            console.error("ğŸ”§ [EventSource] SSE é”™è¯¯ï¼š", err);
            addLogEntry("âŒ è¿æ¥å·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥åç«¯çŠ¶æ€æˆ–åˆ·æ–°é¡µé¢ã€‚");
        };
        
        eventSource.onopen = function(event) {
            console.log("âœ… [EventSource] SSE è¿æ¥å·²å»ºç«‹");
            addLogEntry("âœ… SSE è¿æ¥å·²å»ºç«‹");
        };
    }
   


    function addLogEntry(message) {
        const outputContent = document.getElementById("output-box");
        const timestamp = new Date().toLocaleTimeString();
        const p = document.createElement('p');
        p.textContent = `[${timestamp}] ${message}`;
        outputContent.prepend(p);
        
        if (outputContent.children.length > 20) {
            outputContent.removeChild(outputContent.lastChild);
        }
    }

    // é”®ç›˜äº‹ä»¶ç›‘å¬
    document.getElementById('voice-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendVoiceCommand();
        }
    });

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        showSlide(currentIndex);
        initSliders();
        initGauge();
        initEventSource();
        
        // åˆå§‹åŒ–å½•éŸ³åŠŸèƒ½ï¼ˆå»¶è¿Ÿåˆå§‹åŒ–ï¼Œé¿å…é˜»å¡é¡µé¢åŠ è½½ï¼‰
        setTimeout(() => {
            initAudioRecording();
        }, 1000);
        
        document.getElementById('voice-indicator').addEventListener('click', toggleVoiceListening);
        
        setInterval(updateTime, 1000);
        updateTime();
        
        // æ–°å¢ï¼šåˆå§‹åŒ–æ³¨æ„åŠ›è­¦å‘ŠéŸ³é¢‘
        setTimeout(() => {
            initAttentionAudio();
        }, 1000);

        setTimeout(() => {
            addLogEntry('ğŸš— è½¦è½½é¢æ¿åˆå§‹åŒ–å®Œæˆï¼Œè¯­éŸ³è¯†åˆ«å°±ç»ª');
            addLogEntry('ğŸ’¡ ç‚¹å‡»å³ä¸‹è§’éº¦å…‹é£å›¾æ ‡å¼€å§‹è¯­éŸ³äº¤äº’');
            addLogEntry('ğŸ¤ æ”¯æŒçš„æŒ‡ä»¤ï¼šæ‰“å¼€/å…³é—­ç©ºè°ƒã€æ’­æ”¾/æš‚åœéŸ³ä¹ã€å¼€å¯/å…³é—­å¯¼èˆªç­‰');
            addLogEntry('âœ… è¯­éŸ³è¯†åˆ«æ¨¡å¼ï¼šæŒ‰éœ€å¯åŠ¨ï¼ˆåªåœ¨ç‚¹å‡»å½•éŸ³æŒ‰é’®æ—¶è¿›è¡Œè¯†åˆ«ï¼‰');
            addLogEntry('ğŸ§ª æµ‹è¯•åŠŸèƒ½ï¼šç‚¹å‡»å·¦ä¸‹è§’"æµ‹è¯•è­¦å‘Š"æŒ‰é’®éªŒè¯æ³¨æ„åŠ›åç¦»è­¦å‘Š');
        }, 1000);
    });

    // æ·»åŠ äº‹ä»¶æºç›‘å¬å™¨
    
</script>
</body>
</html>
