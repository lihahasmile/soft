<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šæ¨¡æ€äº¤äº’æ—¥å¿—ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/log.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-brain"></i>
                <h1>å¤šæ¨¡æ€äº¤äº’æ—¥å¿—ç®¡ç†ç³»ç»Ÿ</h1>
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="æœç´¢æ—¥å¿—å†…å®¹...">
                <select id="searchBy">
                    <option value="all">æ‰€æœ‰å­—æ®µ</option>
                    <option value="id">ID</option>
                    <option value="action">Action</option>
                    <option value="username">ç”¨æˆ·å</option>
                </select>
                <button class="btn" id="searchBtn"><i class="fas fa-search"></i> æœç´¢</button>
            </div>
            <button class="btn" id="addLogBtn"><i class="fas fa-plus"></i> æ·»åŠ æ–°æ—¥å¿—</button>
        </header>
        
        <div class="dashboard">
            <div class="card stat-card">
                <i class="fas fa-database"></i>
                <h3>æ€»æ—¥å¿—æ•°é‡</h3>
                <div class="value" id="totalLogs">0</div>
            </div>
            <div class="card stat-card">
                <i class="fas fa-microphone"></i>
                <h3>è¯­éŸ³äº¤äº’</h3>
                <div class="value" id="voiceLogs">0</div>
            </div>
            <div class="card stat-card passenger-card">
                <i class="fas fa-hand-sparkles"></i>
                <h3>æ‰‹åŠ¿äº¤äº’</h3>
                <div class="value" id="gestureLogs">0</div>
            </div>
            <div class="card stat-card">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>é¢éƒ¨ä¸è§†çº¿äº¤äº’</h3>
                <div class="value" id="faceLogs">0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-table"></i> äº¤äº’æ—¥å¿—åˆ—è¡¨</h2>
                </div>
                
                <div class="table-container">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·</th>
                                <th>è§’è‰²</th>
                                <th>ç±»å‹</th>
                                <th>äº¤äº’å†…å®¹</th>
                                <th>æ—¶é—´æˆ³</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- æ—¥å¿—æ•°æ®å°†é€šè¿‡JSåŠ¨æ€å¡«å…… -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="pagination">
                    <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="two-panel">
                <div class="panel-header">
                    <div class="scroll-tip">â† æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šç”¨æˆ· â†’</div>
                    <h2 class="panel-title"><i class="fas fa-users-cog"></i> å„ç”¨æˆ·ä¹ æƒ¯</h2>
                </div>
                <div class="habit-user-list" id="habitUserList" style="padding: 1rem;">
                    <!-- ç”¨æˆ·ä¹ æƒ¯åˆ—è¡¨é€šè¿‡ JS åŠ¨æ€å¡«å…… -->
                </div>

                <div class="panel-header">
                    <h2 class="panel-title"><i class="fas fa-chart-line"></i> æ•°æ®åˆ†æ</h2>
                </div>
                
                <div class="chart-container">
                    <canvas id="interactionChart"></canvas>
                </div>
                
                <div class="gesture-chart" id="gestureChart">
                    <!-- æ‰‹åŠ¿åˆ†æå°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ /ç¼–è¾‘æ—¥å¿—æ¨¡æ€æ¡† -->
    <div class="modal" id="logModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ·»åŠ æ–°æ—¥å¿—</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="logForm">
                <input type="hidden" id="logId">
                <div class="form-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="username" required placeholder="è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>äº¤äº’è§’è‰²</label>
                    <select id="role" required>
                        <option value="">é€‰æ‹©è§’è‰²</option>
                        <option value="driver">é©¾é©¶å‘˜</option>
                        <option value="passenger">ä¹˜å®¢</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>äº¤äº’ç±»å‹</label>
                    <select id="type" required>
                        <option value="">é€‰æ‹©ç±»å‹</option>
                        <option value="è¯­éŸ³">è¯­éŸ³</option>
                        <option value="æ‰‹åŠ¿">æ‰‹åŠ¿</option>
                        <option value="é¢éƒ¨">é¢éƒ¨ä¸è§†çº¿</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>äº¤äº’å†…å®¹</label>
                    <textarea rows="3" id="action" required placeholder="è¾“å…¥äº¤äº’å†…å®¹..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline close-modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // æ˜¾ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–æ—¥å¿—æ•°æ®
            function fetchLogs(page = 1, search = '', searchBy = 'all') {
                fetch(`/logs/get_logs?search=${search}&search_by=${searchBy}&page=${page}`)
                    .then(response => response.json())
                    .then(data => {
                        // æ›´æ–°æ—¥å¿—è¡¨æ ¼
                        const logsTableBody = document.querySelector('#logsTable tbody');
                        logsTableBody.innerHTML = '';
                        
                        data.logs.forEach(log => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${log.id}</td>
                                <td>${log.username}</td>
                                <td>${log.role}</td>
                                <td>${log.type}</td>
                                <td>${log.action}</td>
                                <td>${new Date(log.timestamp).toLocaleString()}</td>
                                <td>
                                    <div class="button-container">
                                        <button class="btn btn-sm edit-btn" data-id="${log.id}">ç¼–è¾‘</button>
                                        <button class="btn btn-sm delete-btn" data-id="${log.id}">åˆ é™¤</button>
                                    </div>
                                </td>
                            `;
                            logsTableBody.appendChild(row);
                        });
                        
                        // æ›´æ–°åˆ†é¡µ
                        const pagination = document.getElementById('pagination');
                        pagination.innerHTML = '';
                        
                        const totalPages = data.total_pages;
                        for (let i = 1; i <= totalPages; i++) {
                            const pageBtn = document.createElement('button');
                            pageBtn.textContent = i;
                            pageBtn.classList.add('page-btn');
                            if (i === data.current_page) {
                                pageBtn.classList.add('active');
                            }
                            pageBtn.addEventListener('click', () => fetchLogs(i, search));
                            pagination.appendChild(pageBtn);
                        }
                        
                        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                        document.getElementById('totalLogs').textContent = data.total;
                        
                        // è·å–è¯¦ç»†ç»Ÿè®¡
                        fetch('/logs/stats')
                            .then(response => response.json())
                            .then(stats => {
                                // ä»role_statsä¸­æå–
                                const roleStats = stats.type_stats;
                                document.getElementById('voiceLogs').textContent = roleStats['è¯­éŸ³'] || 0;
                                document.getElementById('gestureLogs').textContent = roleStats['æ‰‹åŠ¿'] || 0;
                                document.getElementById('faceLogs').textContent = roleStats['é¢éƒ¨'] || 0;
                                
                                // æ›´æ–°å›¾è¡¨
                                updateCharts(stats);
                            });
                    });
            }
            
            // åˆå§‹åŒ–å›¾è¡¨
            let interactionChart;
            function updateCharts(stats) {
                const ctx = document.getElementById('interactionChart').getContext('2d');
                
                if (interactionChart) {
                    interactionChart.destroy();
                }
                
                // ä»ç»Ÿè®¡ä¸­æå–è§’è‰²æ•°æ®
                const roleStats = stats.role_stats;
                const labels = Object.keys(roleStats);
                const dataValues = Object.values(roleStats);
                
                interactionChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'äº¤äº’æ•°é‡',
                            data: dataValues,
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 99, 132, 0.6)'
                            ],
                            borderColor: [
                                'rgba(75, 192, 192, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // åˆå§‹åŠ è½½æ—¥å¿—
            fetchLogs(1, '');
            
            // æœç´¢æ¡†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('searchBtn').addEventListener('click', function() {
                const searchInput = document.getElementById('searchInput').value;
                const searchBy = document.getElementById('searchBy').value; // è·å–æœç´¢å­—æ®µ
                fetchLogs(1, searchInput, searchBy);
            });
            
            // æ·»åŠ æ—¥å¿—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('addLogBtn').addEventListener('click', function() {
                document.getElementById('modalTitle').textContent = 'æ·»åŠ æ–°æ—¥å¿—';
                document.getElementById('logId').value = '';
                document.getElementById('logForm').reset();
                document.getElementById('logModal').style.display = 'block';
            });
            
            // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('logModal').style.display = 'none';
                });
            });
            
            // æ¨¡æ€æ¡†å¤–éƒ¨ç‚¹å‡»å…³é—­
            window.addEventListener('click', function(event) {
                if (event.target === document.getElementById('logModal')) {
                    document.getElementById('logModal').style.display = 'none';
                }
            });
            
            // æäº¤æ—¥å¿—è¡¨å•
            document.getElementById('logForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const logId = document.getElementById('logId').value;
                const username = document.getElementById('username').value;
                const role = document.getElementById('role').value;
                const type = document.getElementById('type').value;
                const action = document.getElementById('action').value;
                
                const formData = {
                    username,
                    role,
                    type,
                    action
                };
                
                const apiUrl = logId ? `/logs/up_logs/${logId}` : '/logs/add_logs';
                const method = logId ? 'PUT' : 'POST';
                
                fetch(apiUrl, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.id || data.success) {
                        document.getElementById('logModal').style.display = 'none';
                        fetchLogs(1, '');
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('è¯·æ±‚å‡ºé”™');
                });
            });
            
            // è¡¨æ ¼ä¸­çš„ç¼–è¾‘æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-btn')) {
                    const logId = e.target.dataset.id;
                    fetch(`/logs/get_logs/${logId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(log => {
                            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘æ—¥å¿—';
                            document.getElementById('logId').value = log.id;
                            document.getElementById('username').value = log.username || '';
                            document.getElementById('role').value = log.role || '';
                            document.getElementById('type').value = log.type || '';
                            document.getElementById('action').value = log.action || '';
                            document.getElementById('logModal').style.display = 'block';
                        })
                        .catch(error => {
                            console.error('Error fetching log:', error);
                            alert('è·å–æ—¥å¿—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                        });
                } else if (e.target.classList.contains('delete-btn')) {
                    const logId = e.target.dataset.id;
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥å¿—å—?')) {
                        fetch(`/logs/de_logs/${logId}`, {
                            method: 'DELETE',
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                fetchLogs(1, '');
                            } else {
                                alert('åˆ é™¤å¤±è´¥: ' + data.error);
                            }
                        });
                    }
                }
            });
        });

// è·å–æ¯ä¸ªç”¨æˆ·çš„ä¹ æƒ¯æ•°æ®
const habitList = document.getElementById('habitUserList');
const scrollTip = document.querySelector('.scroll-tip');

if (habitList.scrollWidth > habitList.clientWidth) {
    scrollTip.style.display = 'block';
} else {
    scrollTip.style.display = 'none';
}

fetch('/logs/habit_list')
    .then(res => res.json())
    .then(data => {
        const listContainer = document.getElementById('habitUserList');
        if (!data.habits || data.habits.length === 0) {
            listContainer.innerHTML = '<p>æš‚æ— ç”¨æˆ·ä¹ æƒ¯æ•°æ®</p>';
            return;
        }

        data.habits.forEach(habit => {
            const userCard = document.createElement('div');
            userCard.classList.add('habit-card');
            userCard.innerHTML = `
                <div class="habit-header">ğŸ‘¤ ${habit.username}</div>
                <div class="habit-values">
                    <div class="habit-item">ğŸŒ¡ï¸ ç©ºè°ƒæ¸©åº¦ï¼š<span>${habit.temperature}Â°C</span></div>
                    <div class="habit-item">ğŸµ éŸ³ä¹éŸ³é‡ï¼š<span>${habit.music}%</span></div>
                    <div class="habit-item">ğŸ”Š åª’ä½“éŸ³é‡ï¼š<span>${habit.media}%</span></div>
                </div>
            `;
            listContainer.appendChild(userCard);
        });
    })
    .catch(err => {
        console.warn('âŒ è·å–ç”¨æˆ·ä¹ æƒ¯åˆ—è¡¨å¤±è´¥:', err);
    });

    </script>
</body>
</html>